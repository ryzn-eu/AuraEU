<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aura</title>
    
    <link rel="icon" href="https://via.placeholder.com/192x192">
    <link rel="apple-touch-icon" href="https://via.placeholder.com/192x192">
    <meta name="theme-color" content="#171717">

    <link rel="manifest" href="./manifest.json">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <style>
        /* Variabili di Tema Dinamiche (Glaciale/Natale) */
        :root {
            --ryzn-color-hex: #00BFFF; /* Glacial Blue */
            --ryzn-color-rgb: 0 191 255;
            --ryzn-bg-color: #171717; 
            --ryzn-color-dark: 0 150 200; /* Darker blue shade */
        }

        /* Classi Tailwind Dinamiche */
        .ryzn-bg { 
            background-color: var(--ryzn-bg-color); 
        }
        .accent-text { color: var(--ryzn-color-hex); }
        .accent-bg { background-color: var(--ryzn-color-hex); }
        .accent-border { border-color: var(--ryzn-color-hex); }
        .accent-hover:hover { filter: brightness(1.2); }
        .shadow-ryzn-accent\/30 { box-shadow: 0 10px 15px -3px rgba(var(--ryzn-color-rgb) / 0.3), 0 4px 6px -2px rgba(var(--ryzn-color-rgb) / 0.1); }
        .fill-ryzn-accent\/30 { fill: rgba(var(--ryzn-color-rgb) / 0.3); }

        /* Effetto Glassmorphism (Depth-Glass) */
        .depth-glass {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        /* Stile Logo con Gradiente Dinamico */
        .logo-aura { font-size: 2.5rem; font-weight: 900; }
        .logo-text {
            background: linear-gradient(45deg, var(--ryzn-color-hex), #B3E0FF); 
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-fill-color: transparent;
        }
        
        /* Transizioni Icone */
        .animated-icon {
            transition: transform 0.2s ease, opacity 0.2s ease, fill 0.3s ease;
        }
        
        /* --- FIX SFONDO MOBILE --- */
        /* Container dedicato per l'immagine fissa */
        .fixed-background {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -2; /* Dietro a tutto */
            background-image: url('https://raw.githubusercontent.com/ryzn-eu/AuraEU/main/User/Foto.png');
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            pointer-events: none; /* Assicura che non blocchi i click */
        }

        /* Layout Base */
        body {
            background-color: transparent; /* Trasparente per vedere il div fixed-background */
            color: white;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            padding-bottom: 96px; 
            overflow-x: hidden;
            position: relative;
        }
        
        /* Overlay scuro per migliorare leggibilit√† testo su sfondo immagine */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6); 
            z-index: -1; /* Sopra l'immagine, sotto il contenuto */
            pointer-events: none;
        }

        .container-app {
            flex-grow: 1;
            padding: 1rem;
            max-width: 1400px;
            margin: 0 auto;
            width: 100%;
            z-index: 1; /* Assicura che il contenuto sia sopra l'overlay */
        }

        .section-page {
            display: none;
            opacity: 0;
            transition: opacity 0.5s ease;
        }
        .section-page.active {
            display: block;
            opacity: 1;
        }
        
        /* Player Bar (PIP) */
        .player-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            height: 80px;
            z-index: 100;
            transform: translateY(100%);
            transition: transform 0.3s ease-out;
        }
        .player-bar.active {
             transform: translateY(0);
        }
        
        /* Modal Generici */
        .modal {
            animation: fadeIn 0.3s ease-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        /* Toast */
        #toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 200;
        }
        
        /* Audio Nascosto */
        #audio-player-container {
            position: absolute;
            top: -9999px; 
            left: -9999px;
            width: 1px;
            height: 1px;
            overflow: hidden;
            opacity: 0;
        }
        
        /* Snow */
        .snow-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 9999;
            overflow: hidden;
        }
        .flake {
            position: absolute;
            top: -10%;
            color: white;
            font-size: 10px;
            opacity: 0.8;
            animation: fall linear infinite;
            text-shadow: 0 0 3px rgba(var(--ryzn-color-rgb) / 0.5);
        }
        @keyframes fall {
            to { transform: translateY(100vh); }
        }
        
        /* Marquee */
        .title-wrapper { overflow: hidden; white-space: nowrap; }
        .marquee {
            display: inline-block;
            animation: marquee 10s linear infinite;
            padding-left: 100%; 
            animation-play-state: paused;
        }
        .title-wrapper.is-long .marquee { animation-play-state: running; }
        @keyframes marquee {
            0%   { transform: translate(0, 0); }
            100% { transform: translate(-100%, 0); }
        }

        /* Scroll Orizzontale */
        .horizontal-scroll {
            display: flex;
            overflow-x: auto;
            padding-bottom: 1rem;
            gap: 1rem;
            scrollbar-color: var(--ryzn-color-hex) #1f2937;
            scrollbar-width: thin;
        }
        .horizontal-scroll::-webkit-scrollbar { height: 8px; }
        .horizontal-scroll::-webkit-scrollbar-thumb { background: var(--ryzn-color-hex); border-radius: 4px; }
        .horizontal-scroll::-webkit-scrollbar-track { background: rgba(255, 255, 255, 0.1); }
        .horizontal-widget-item { flex: 0 0 160px; width: 160px; min-width: 160px; }
        
        /* Custom Scrollbar Generica */
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: rgba(255, 255, 255, 0.2); border-radius: 3px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }

        /* Banner Contest */
        .promo-banner {
            /* Azzurro (#00BFFF) to Verde Boreale (#005C53) */
            background: linear-gradient(135deg, #00BFFF 0%, #005C53 100%);
            border-radius: 24px;
            padding: 24px;
            box-shadow: 0 10px 25px -5px rgba(0, 191, 255, 0.4);
            margin-bottom: 40px;
        }
        .promo-title {
            font-size: 1.8rem;
            font-weight: 800;
            text-align: center;
            color: white;
            margin-bottom: 20px;
            text-transform: uppercase;
            letter-spacing: 1px;
            text-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        /* Nuovo stile per il countdown */
        .promo-countdown {
            text-align: center;
            margin-top: 20px;
            color: rgba(255, 255, 255, 0.9);
            font-weight: 600;
            font-size: 1.1rem;
            font-family: monospace;
            padding-top: 15px;
            border-top: 1px solid rgba(255,255,255,0.2);
        }

        /* --- STILI LYRICS SPOTIFY-STYLE --- */
        .lyrics-container-spotify {
            width: 100%;
            height: 180px; /* Altezza fissa per il banner testi */
            overflow-y: auto;
            padding: 10px 0;
            text-align: center;
            margin-top: 20px;
            /* Sfumatura sopra e sotto per effetto scroll infinito */
            mask-image: linear-gradient(to bottom, transparent 0%, black 15%, black 85%, transparent 100%);
            -webkit-mask-image: linear-gradient(to bottom, transparent 0%, black 15%, black 85%, transparent 100%);
            /* Nascondi scrollbar ma permetti scroll */
            -ms-overflow-style: none;
            scrollbar-width: none;
            scroll-behavior: smooth;
        }
        .lyrics-container-spotify::-webkit-scrollbar {
            display: none;
        }

        .lyric-line {
            font-size: 1.1rem;
            line-height: 1.6;
            color: rgba(255, 255, 255, 0.4); /* Grigio trasparente per linee non attive */
            margin-bottom: 12px;
            transition: all 0.4s cubic-bezier(0.25, 0.8, 0.25, 1);
            font-weight: 600;
            cursor: pointer;
            padding: 4px 10px;
            border-radius: 8px;
        }
        
        .lyric-line:hover {
            color: rgba(255, 255, 255, 0.7);
        }

        .lyric-line.active {
            color: #ffffff; /* Bianco puro */
            transform: scale(1.08); /* Leggero ingrandimento */
            text-shadow: 0 0 15px rgba(255, 255, 255, 0.4); /* Glow */
            font-weight: 800;
        }

    </style>
</head>
<body class="ryzn-bg">

    <div class="fixed-background"></div>

    <div id="snow-container" class="snow-container"></div>

    <div id="toast-container"></div>
    
    <div id="audio-player-container">
        <audio id="audioPlayer" playsinline></audio>
    </div>

    <div id="auth-modal" class="fixed inset-0 bg-black/70 backdrop-blur-sm z-[150] hidden flex items-center justify-center p-4 modal">
        <div class="depth-glass bg-ryzn-bg p-6 rounded-2xl w-full max-w-sm shadow-2xl relative">
            <h3 id="auth-title" class="text-2xl font-bold mb-6 accent-text text-center">Accedi ad Aura Music</h3>
            <input type="email" id="auth-email" placeholder="Email" class="w-full p-3 rounded-lg bg-white/10 border border-white/20 focus:accent-border text-white placeholder-gray-500 mb-3">
            <input type="password" id="auth-password" placeholder="Password" class="w-full p-3 rounded-lg bg-white/10 border border-white/20 focus:accent-border text-white placeholder-gray-500 mb-6">
            <button id="auth-main-button" onclick="handleAuthAction('login')" class="w-full py-3 accent-bg rounded-lg text-white font-bold accent-hover transition">Accedi</button>
            <div class="text-center mt-4">
                <button id="auth-switch-link" onclick="switchAuthMode('register')" class="text-sm text-gray-400 hover:accent-text transition">Registrati</button>
            </div>
             <button onclick="closeAuthModal()" class="absolute top-3 right-3 text-gray-400 hover:text-white transition"><i data-lucide="x" class="w-6 h-6"></i></button>
        </div>
    </div>
    
    <div id="search-modal" class="fixed inset-0 bg-black/70 backdrop-blur-sm z-[150] hidden flex flex-col p-4 modal">
        <div class="w-full max-w-2xl mx-auto depth-glass bg-ryzn-bg p-6 rounded-2xl shadow-2xl relative">
            <div class="flex items-center mb-4">
                <input type="text" id="search-input" oninput="performSearch()" placeholder="Cerca brani o artisti locali..." class="flex-grow p-3 rounded-l-lg bg-white/10 border border-white/20 text-white placeholder-gray-500 focus:outline-none">
                <button onclick="performSearch()" class="p-3 accent-bg rounded-r-lg accent-hover"><i data-lucide="search" class="w-6 h-6"></i></button>
            </div>
            <div id="search-results" class="max-h-96 overflow-y-auto space-y-3 p-2">
                <p class="text-center text-gray-500">Inizia a digitare per cercare nella libreria locale.</p>
            </div>
            <button onclick="closeSearchModal()" class="absolute top-3 right-3 text-gray-400 hover:text-white transition"><i data-lucide="x" class="w-6 h-6"></i></button>
        </div>
    </div>

    <div id="artist-modal" class="fixed inset-0 bg-black/80 backdrop-blur-md z-[160] hidden flex items-center justify-center p-4 modal">
        <div class="depth-glass bg-ryzn-bg/90 p-0 rounded-3xl w-full max-w-lg shadow-2xl relative overflow-hidden flex flex-col max-h-[85vh]">
            <div class="relative h-48 sm:h-64 w-full">
                <img id="artist-modal-image" src="" alt="Artist" class="w-full h-full object-cover">
                <div class="absolute inset-0 bg-gradient-to-t from-ryzn-bg via-transparent to-transparent"></div>
                <button onclick="closeArtistModal()" class="absolute top-4 right-4 p-2 bg-black/50 rounded-full text-white hover:bg-white/20 transition backdrop-blur-sm">
                    <i data-lucide="x" class="w-6 h-6"></i>
                </button>
                <div class="absolute bottom-4 left-6 right-6">
                    <h2 id="artist-modal-name" class="text-4xl font-extrabold text-white drop-shadow-lg">Nome Artista</h2>
                    <p id="artist-modal-genre" class="text-gray-300 text-sm font-medium mt-1 badge inline-block px-2 py-1 rounded-md bg-white/10 backdrop-blur-md border border-white/10">Genere</p>
                </div>
            </div>
            <div class="p-6 overflow-y-auto custom-scrollbar">
                <div class="mb-6">
                    <h4 class="text-accent-text font-bold mb-2 text-sm uppercase tracking-wider">Biografia</h4>
                    <p id="artist-modal-bio" class="text-gray-300 leading-relaxed text-sm sm:text-base"></p>
                </div>
                <div id="artist-modal-socials" class="flex space-x-4 mt-4 pt-4 border-t border-white/10"></div>
            </div>
        </div>
    </div>

    <div id="album-modal" class="fixed inset-0 bg-black/80 backdrop-blur-md z-[160] hidden flex items-center justify-center p-4 modal">
        <div class="depth-glass bg-ryzn-bg/90 p-0 rounded-3xl w-full max-w-lg shadow-2xl relative overflow-hidden flex flex-col max-h-[85vh]">
            
            <div class="relative h-48 sm:h-64 w-full flex-shrink-0">
                <img id="album-modal-image" src="" alt="Album Cover" class="w-full h-full object-cover">
                <div class="absolute inset-0 bg-gradient-to-t from-ryzn-bg via-transparent to-transparent"></div>
                
                <button onclick="closeAlbumModal()" class="absolute top-4 right-4 p-2 bg-black/50 rounded-full text-white hover:bg-white/20 transition backdrop-blur-sm z-20">
                    <i data-lucide="x" class="w-6 h-6"></i>
                </button>
                
                <div class="absolute bottom-4 left-6 right-6">
                    <h2 id="album-modal-title" class="text-3xl sm:text-4xl font-extrabold text-white drop-shadow-lg truncate">Titolo Album</h2>
                    <p id="album-modal-artist" class="text-gray-300 text-sm font-medium mt-1">Artista</p>
                </div>
            </div>

            <div class="p-4 overflow-y-auto custom-scrollbar flex-grow">
                <div class="flex justify-between items-center mb-4 px-2">
                    <span class="text-xs font-bold text-gray-400 uppercase tracking-wider">Tracce</span>
                    <button id="album-play-all" class="p-3 accent-bg rounded-full hover:scale-105 transition shadow-lg shadow-ryzn-accent/50">
                        <i data-lucide="play" class="w-5 h-5 text-ryzn-bg fill-ryzn-bg"></i>
                    </button>
                </div>
                <div id="album-track-list" class="space-y-2">
                    </div>
            </div>
        </div>
    </div>
    
    <div id="create-playlist-modal" class="fixed inset-0 bg-black/70 backdrop-blur-sm z-[150] hidden flex items-center justify-center p-4">
        <div class="depth-glass bg-ryzn-bg p-6 rounded-2xl w-full max-w-sm shadow-2xl relative">
            <h3 class="text-xl font-bold mb-4 accent-text">Crea Nuova Sessione</h3>
            <input type="text" id="playlist-name-input" placeholder="Nome della sessione" class="w-full p-3 rounded-lg bg-white/10 border border-white/20 focus:accent-border text-white placeholder-gray-500 mb-4">
            <div class="flex justify-end space-x-3">
                <button onclick="closeCreatePlaylistModal()" class="px-4 py-2 text-gray-400 hover:text-white transition rounded-lg">Annulla</button>
                <button onclick="createPlaylist()" class="px-4 py-2 accent-bg rounded-lg text-white font-bold accent-hover transition">Crea</button>
            </div>
            <button onclick="closeCreatePlaylistModal()" class="absolute top-3 right-3 text-gray-400 hover:text-white transition"><i data-lucide="x" class="w-6 h-6"></i></button>
        </div>
    </div>

    <div id="add-to-playlist-modal" class="fixed inset-0 bg-black/70 backdrop-blur-sm z-[150] hidden flex items-center justify-center p-4">
        <div class="depth-glass bg-ryzn-bg p-6 rounded-2xl w-full max-w-sm shadow-2xl relative">
            <h3 class="text-xl font-bold mb-4 accent-text">Aggiungi a Sessione</h3>
            <div id="playlist-selection-list" class="max-h-64 overflow-y-auto space-y-2 p-1">
                <p class="text-center text-gray-500">Nessuna sessione trovata.</p>
            </div>
            <button onclick="closeAddToPlaylistModal()" class="absolute top-3 right-3 text-gray-400 hover:text-white transition"><i data-lucide="x" class="w-6 h-6"></i></button>
        </div>
    </div>

    <div id="immersive-mode" class="fixed inset-0 bg-black/90 backdrop-blur-xl z-[150] hidden flex flex-col items-center justify-center p-6 modal overflow-y-auto">
        
        <div class="absolute top-6 left-6 flex items-center space-x-4 z-10">
            <button onclick="event.stopPropagation(); exitImmersiveMode()" class="text-white/80 hover:text-white transition"><i data-lucide="chevron-down" class="w-8 h-8"></i></button>
            <h2 class="text-xl font-semibold">In Riproduzione</h2>
        </div>
        
        <div class="flex flex-col items-center w-full max-w-xl md:max-w-2xl pt-20 pb-10">
            
            <div id="immersive-player-visual-container" class="w-full max-w-[280px] sm:max-w-sm aspect-square rounded-3xl shadow-2xl shadow-ryzn-accent/30 overflow-hidden bg-black flex items-center justify-center mb-8 sm:mb-10 transition-all duration-300 relative">
                 <img id="immersive-cover" src="" alt="Album Cover" class="w-full h-full object-cover">
                 <iframe 
                    id="immersive-video-player" 
                    width="600" height="480" 
                    src="" scrolling="no" frameborder="0" allowfullscreen="true" 
                    class="w-full h-full object-contain bg-black hidden">
                 </iframe>
            </div>
            
            <div class="flex flex-col items-center space-y-6 max-w-lg w-full px-4">
                <div class="text-center w-full">
                    <div id="immersive-title-wrapper" class="title-wrapper max-w-full text-3xl sm:text-4xl font-extrabold mx-auto">
                        <h3 id="immersive-title" class="text-3xl sm:text-4xl font-extrabold"><span class="marquee">Titolo Brano</span></h3>
                    </div>
                    <p id="immersive-artist" class="text-lg sm:text-xl text-gray-400 truncate mt-2">Artista</p>
                </div>
                
                <div class="flex space-x-4">
                    <button id="switch-to-video-btn" onclick="event.stopPropagation(); toggleImmersiveVisuals()" class="p-2 depth-glass rounded-full text-white hover:bg-white/10 transition hidden">
                        <i data-lucide="video" class="w-5 h-5"></i>
                    </button>
                </div>

                <div id="progress-bar-immersive-container" class="w-full h-2 bg-white/20 rounded-full cursor-pointer relative group">
                    <div id="progress-bar-immersive" class="h-2 accent-bg rounded-full relative" style="width: 0;">
                         <div class="absolute right-0 top-1/2 transform -translate-y-1/2 w-3 h-3 bg-white rounded-full opacity-0 group-hover:opacity-100 transition shadow-md"></div>
                    </div>
                </div>

                <div class="flex space-x-6 sm:space-x-10 items-center justify-center w-full">
                    <button id="loop-button-immersive" onclick="event.stopPropagation(); toggleLoop()" class="text-white/70 hover:text-white transition">
                        <i data-lucide="repeat" class="w-6 h-6 sm:w-8 sm:h-8"></i>
                    </button>
                    <button onclick="event.stopPropagation(); skipBackward()" class="text-white/70 hover:text-white transition">
                        <i data-lucide="skip-back" class="w-8 h-8 sm:w-10 sm:h-10 fill-current"></i>
                    </button>
                    <button onclick="event.stopPropagation(); togglePlayPause()" class="p-4 accent-bg rounded-full hover:scale-105 transition shadow-xl shadow-ryzn-accent/50">
                        <i id="immersive-play-icon" data-lucide="play" class="w-8 h-8 sm:w-10 sm:h-10 text-ryzn-bg animated-icon fill-current"></i> 
                    </button>
                    <button onclick="event.stopPropagation(); skipForward()" class="text-white/70 hover:text-white transition">
                        <i data-lucide="skip-forward" class="w-8 h-8 sm:w-10 sm:h-10 fill-current"></i>
                    </button>
                    <button onclick="event.stopPropagation(); toggleLike()" id="like-button-immersive" class="text-white/70 hover:text-red-400 transition">
                        <i data-lucide="heart" class="w-6 h-6 sm:w-8 sm:h-8 fill-current"></i>
                    </button>
                </div>

                <div id="lyrics-container" class="lyrics-container-spotify hidden">
                    <p class="text-gray-500 mt-10">Caricamento testo...</p>
                </div>

            </div>
        </div>
    </div>
    
    <div class="container-app">
        
        <header class="flex justify-between items-center mb-8">
            <div class="flex items-center space-x-8">
                <a href="#" onclick="showSection('music')" class="cursor-pointer">
                    <h1 class="logo-aura flex items-center space-x-2">
                        <i data-lucide="sparkles" class="w-7 h-7 accent-text fill-ryzn-accent/30"></i>
                        <span class="logo-text">Aura</span>
                    </h1>
                </a>
                <nav class="hidden sm:flex space-x-6 text-gray-400 text-lg font-medium">
                    <button id="nav-music" onclick="showSection('music')" class="nav-item hover:accent-text transition pb-1">Scopri</button>
                </nav>
            </div>
            
            <div class="flex items-center space-x-3">
                 <button onclick="showSection('playlists')" class="p-2 depth-glass rounded-full text-white hover:bg-white/10 transition">
                    <i data-lucide="list-music" class="w-6 h-6"></i>
                 </button>
                 <button onclick="showSection('library')" class="p-2 depth-glass rounded-full text-white hover:bg-white/10 transition">
                    <i data-lucide="heart" class="w-6 h-6 fill-current"></i>
                 </button>
                 <button onclick="openSearchModal()" class="p-2 depth-glass rounded-full text-white hover:bg-white/10 transition">
                    <i data-lucide="search" class="w-6 h-6"></i>
                 </button>
                 <button id="auth-button-header" onclick="loggedInUser ? showSection('profile') : openAuthModal('login')" class="p-2 depth-glass rounded-full text-white hover:bg-white/10 transition">
                    <i data-lucide="user" class="w-6 h-6"></i>
                 </button>
            </div>
        </header>
        
        <hr class="border-white/10 my-6 md:my-10">

        <section id="music-section" class="section-page active">
            <h2 id="home-greeting" class="text-4xl font-extrabold mb-8 text-white">Buonasera. La tua Vibe √® pronta.</h2>
            <div id="home-widgets-container" class="space-y-10">
                <p class="text-center text-gray-400 col-span-full"><i data-lucide="loader-2" class="w-5 h-5 animate-spin inline-block mr-2"></i> Caricamento in corso...</p>
            </div>
        </section>
        
        <section id="library-section" class="section-page">
            <h2 class="text-3xl font-bold mb-6">I Tuoi Brani Salvati</h2>
            <div id="liked-tracks-list" class="space-y-3">
                <p class="text-center p-4 text-gray-500">Nessun brano salvato.</p>
            </div>
        </section>

        <section id="playlists-section" class="section-page">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-3xl font-bold">Le Tue Sessioni</h2>
                <button onclick="openCreatePlaylistModal()" class="flex items-center px-4 py-2 accent-bg rounded-full text-sm font-semibold accent-hover transition">
                    <i data-lucide="plus" class="w-4 h-4 mr-1"></i> Crea Sessione
                </button>
            </div>
            <div id="playlists-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                <p class="text-center p-4 text-gray-500 col-span-full">Nessuna sessione creata.</p>
            </div>
        </section>

        <section id="profile-section" class="section-page">
            <h2 class="text-3xl font-bold mb-6">Profilo Utente</h2>
            <div class="depth-glass p-6 rounded-xl max-w-lg space-y-4">
                <p id="profile-info" class="text-lg font-semibold">Stato: Disconnesso</p>
                <div id="vibe-score-display" class="text-xl accent-text font-bold">Vibe Score: 0/100</div>
                <button onclick="handleLogout()" class="px-4 py-2 bg-red-600 rounded-lg text-white font-bold hover:bg-red-700 transition">Disconnetti</button>
            </div>
        </section>

    </div> 
    
    <div onclick="enterImmersiveMode()" class="player-bar depth-glass bg-ryzn-bg/80 border-t border-white/10 flex items-center justify-between px-4 sm:px-8 cursor-pointer">
        
        <div class="flex items-center space-x-4 w-1/3 overflow-hidden">
            <img id="player-cover" src="https://via.placeholder.com/64" alt="Album Cover" class="w-12 h-12 rounded-md object-cover flex-shrink-0">
            <div id="player-title-wrapper" class="title-wrapper truncate">
                <p id="player-title" class="font-bold text-sm"><span class="marquee">Nessun Brano</span></p>
                <p id="player-artist" class="text-xs text-gray-400 truncate">Tocca per iniziare</p>
            </div>
        </div>

        <div class="flex items-center justify-center space-x-4 w-1/3">
            <button onclick="event.stopPropagation(); skipBackward()" class="text-white/70 hover:text-white transition block">
                 <i data-lucide="skip-back" class="w-5 h-5 fill-current"></i>
            </button>
            <button onclick="event.stopPropagation(); togglePlayPause()" class="p-2 accent-bg rounded-full hover:scale-105 transition shadow-lg shadow-ryzn-accent/30">
                <i id="play-icon" data-lucide="play" class="w-6 h-6 text-ryzn-bg animated-icon"></i> 
            </button>
            <button onclick="event.stopPropagation(); skipForward()" class="text-white/70 hover:text-white transition block">
                 <i data-lucide="skip-forward" class="w-5 h-5 fill-current"></i>
            </button>
        </div>

        <div class="flex items-center justify-end space-x-4 w-1/3">
            <button id="switch-to-video-pip" onclick="event.stopPropagation(); enterImmersiveMode('video')" class="text-white/50 hover:text-white transition hidden">
                <i data-lucide="monitor-dot" class="w-5 h-5"></i>
            </button>
            
            <button id="add-to-playlist-button" onclick="event.stopPropagation(); openAddToPlaylistModal()" class="text-white/50 hover:text-white transition">
                <i data-lucide="list-plus" class="w-5 h-5"></i>
            </button>
            <button id="like-button" onclick="event.stopPropagation(); toggleLike()" class="text-white/50 hover:text-red-400 transition">
                <i data-lucide="heart" class="w-5 h-5 fill-current"></i>
            </button>
        </div>

        <div id="progress-bar-container" class="absolute bottom-0 left-0 w-full h-1 bg-transparent cursor-pointer">
            <div id="progress-bar" class="h-1 accent-bg" style="width: 0;"></div>
        </div>
    </div>


    <script>
        // --- CONFIGURAZIONE GITHUB ---
        const GITHUB_RAW_BASE = "https://raw.githubusercontent.com/ryzn-eu/AuraEU/main/";
        
        const FALLBACK_COVER_URL = "https://via.placeholder.com/192x192/171717/00BFFF?text=AURA"; 
        const AUDIO_BASE_URL = GITHUB_RAW_BASE + "audio/"; 
        const COVER_BASE_URL = GITHUB_RAW_BASE + "Covers/"; 
        
        const TRACKS_JSON_URL = GITHUB_RAW_BASE + "tracks.json"; 
        const ARTIST_JSON_URL = GITHUB_RAW_BASE + "artist.json"; 
        
        // --- Dati Locali ---
        let AURA_MAP = []; 
        let ARTISTS_DATA = []; 
        
        let currentTrackData = null;
        let audioPlayer = null; 
        let immersiveVideoPlayer = null; 
        let isImmersiveVideoActive = false; 

        let likedTracks = new Set();
        let userPlaylists = [];
        let isLooping = false;
        let loggedInUser = null;
        let listeningHistory = []; 
        
        let activeFilter = 'Trending'; 
        
        // Riferimenti DOM
        let progressBar, progressBarImmersive, playIcon, immersivePlayIcon, playerTitle, playerArtist, playerCover, immersiveCover, immersiveTitle, immersiveArtist, likeButton, vibeScoreDisplay, progressBarContainer, progressBarImmersiveContainer, loopButtonImmersive, playerBar, switchToVideoBtn, switchToVideoPipBtn;
        let playerTitleWrapper, immersiveTitleWrapper;
        let trackIdToAdd = null; 

        // ‚≠ê Riferimenti per Lyrics
        let lyricsContainer = null;
        let currentLyrics = [];
        
        // --- Mood e Categorie ---
        const MOOD_STYLES = {
            "Invernale": "bg-blue-900/40 border-blue-600 text-blue-300",
            "Party": "bg-red-900/40 border-red-600 text-red-300",
            "Ambient": "bg-gray-800/40 border-gray-600 text-gray-300",
            "Chill": "bg-cyan-900/40 border-cyan-600 text-cyan-300"
        };
        const ALL_MOODS = Object.keys(MOOD_STYLES);
        
        const CATEGORY_MAP = {
            'CR1': { title: 'üéÑ CR1 - Top Hits di Natale', subtitle: 'I brani pop e le hit che scaldano l\'atmosfera delle feste.' },
            'CR2': { title: 'üïØÔ∏è CR2 - Ballate e Relax', subtitle: 'Melodie lente e dolci per serate tranquille e romantiche.' },
            'CR3': { title: 'üîî CR3 - I Classici delle Feste', subtitle: 'Le tracce tradizionali e i canti che fanno Natale.' },
            'CR4': { title: '‚ùÑÔ∏è CR4 - Ambient Glaciale', subtitle: 'Musica strumentale e tracce per creare una perfetta vibe invernale.' },
        };
        const CATEGORY_KEYS = Object.keys(CATEGORY_MAP);
        
        // ====================================================================
        // LOGICHE PLAYER
        // ====================================================================

        function onTrackEnded() {
            if (isLooping) {
                audioPlayer.currentTime = 0;
                audioPlayer.play();
            } else {
                skipForward();
            }
        }
        
        function onPlayerPlay() {
            togglePlayIcon(false); 
            updateMediaSession();
            playerBar.classList.add('active');
        }
        
        function onPlayerPause() {
            togglePlayIcon(true); 
            updateMediaSession();
        }

        // ====================================================================
        // GESTIONE LYRICS (LRC)
        // ====================================================================

        function parseLRC(lrcText) {
            const lines = lrcText.split('\n');
            const result = [];
            const timeReg = /\[(\d{2}):(\d{2})(?:\.(\d{2,3}))?\]/;

            lines.forEach(line => {
                const match = timeReg.exec(line);
                if (match) {
                    const min = parseInt(match[1]);
                    const sec = parseInt(match[2]);
                    const ms = match[3] ? parseInt(match[3]) : 0;
                    const time = min * 60 + sec + (ms / 1000);
                    const text = line.replace(timeReg, '').trim();
                    if (text) result.push({ time, text });
                }
            });
            return result;
        }

        async function loadLyrics(lrcUrl) {
            if (!lrcUrl) {
                currentLyrics = [];
                updateLyricsUI();
                return;
            }
            try {
                const res = await fetch(lrcUrl);
                if (res.ok) {
                    const text = await res.text();
                    currentLyrics = parseLRC(text);
                    updateLyricsUI();
                } else {
                    currentLyrics = [];
                    updateLyricsUI("Testo non disponibile.");
                }
            } catch (e) {
                console.error("Errore lyrics:", e);
                currentLyrics = [];
                updateLyricsUI("Errore caricamento testo.");
            }
        }

        function updateLyricsUI(errorMsg = null) {
            if (!lyricsContainer) return;
            
            // Se c'√® un errore o nessun testo, nascondi il container e esci
            if (errorMsg || currentLyrics.length === 0) {
                lyricsContainer.classList.add('hidden');
                lyricsContainer.innerHTML = '';
                return;
            }

            // Se ci sono testi, mostra il container
            lyricsContainer.classList.remove('hidden');

            const html = currentLyrics.map((line, index) => `
                <div class="lyric-line" id="lyric-${index}" onclick="seekToLyric(${line.time})">
                    ${line.text}
                </div>
            `).join('');
            
            lyricsContainer.innerHTML = html;
        }

        window.seekToLyric = function(time) {
            if(audioPlayer) audioPlayer.currentTime = time;
            audioPlayer.play();
        }

        function syncLyricsDisplay() {
            if (!currentLyrics.length || !lyricsContainer || lyricsContainer.classList.contains('hidden')) return;
            
            const currentTime = audioPlayer.currentTime;
            
            let activeIndex = -1;
            for (let i = 0; i < currentLyrics.length; i++) {
                if (currentTime >= currentLyrics[i].time) {
                    activeIndex = i;
                } else {
                    break;
                }
            }

            document.querySelectorAll('.lyric-line').forEach(el => el.classList.remove('active'));

            if (activeIndex !== -1) {
                const activeLine = document.getElementById(`lyric-${activeIndex}`);
                if (activeLine) {
                    activeLine.classList.add('active');
                    activeLine.scrollIntoView({
                        behavior: 'smooth',
                        block: 'center'
                    });
                }
            }
        }


        // ====================================================================
        // GESTIONE DATI
        // ====================================================================

        function getCoverUrl(track) {
            if (track.albumId) {
                const encodedAlbum = encodeURIComponent(track.albumId.trim());
                return COVER_BASE_URL + encodedAlbum + ".png";
            }
            if (track.categoryID) {
                return COVER_BASE_URL + `${track.categoryID}.png`;
            }
            return FALLBACK_COVER_URL; 
        }

        async function fetchTracks() {
            const container = document.getElementById('home-widgets-container');
            if (container) {
                container.innerHTML = `<p class="text-center text-gray-400 col-span-full"><i data-lucide="loader-2" class="w-5 h-5 animate-spin inline-block mr-2"></i> Caricamento libreria musicale... </p>`;
                lucide.createIcons();
            }

            try {
                const [tracksResponse, artistsResponse] = await Promise.all([
                    fetch(TRACKS_JSON_URL),
                    fetch(ARTIST_JSON_URL)
                ]);

                if (!tracksResponse.ok) throw new Error(`Impossibile recuperare tracks.json`);
                
                const artistsData = artistsResponse.ok ? await artistsResponse.json() : [];
                ARTISTS_DATA = artistsData; 

                const tracksData = await tracksResponse.json();
                
                const artistMap = {};
                if (Array.isArray(artistsData)) {
                    artistsData.forEach(a => {
                        if(a.id && a.name) artistMap[a.id] = a.name;
                    });
                }

                const tracks = tracksData.tracks || [];
                const results = tracks.map((track) => {
                    const title = track.title.trim(); 
                    
                    let normalizedFile = track.file.trim(); 
                    normalizedFile = normalizedFile.replace(/\s(\.[a-zA-Z0-9]+)$/, '$1'); 
                    const encodedFile = encodeURIComponent(normalizedFile);
                    const audioUrl = AUDIO_BASE_URL + encodedFile; 
                    
                    let finalArtistName = "Aura Choice"; 
                    if (track.artistId && artistMap[track.artistId]) {
                        finalArtistName = artistMap[track.artistId];
                    } else if (track.artist) {
                        finalArtistName = track.artist;
                    } else if (track.artistId) {
                        finalArtistName = track.artistId;
                    }
                    
                    const tempTrackObj = { 
                        albumId: track.albumId, 
                        categoryID: track.categoryID 
                    };

                    return {
                        id: title, 
                        title: title,
                        artist: finalArtistName,
                        artistId: track.artistId, 
                        albumId: track.albumId,
                        albumTitle: track.albumTitle || track.albumId, 
                        cover: getCoverUrl(tempTrackObj), 
                        audioUrl: audioUrl, 
                        videoUrl: track.videoUrl || null, 
                        lrcUrl: track.lrcUrl || null,
                        categoryID: track.categoryID, 
                        mood: getTrackMood(), 
                        vibe: Math.floor(Math.random() * 100) + 1,
                        color: getRandomAccentColor(), 
                        rgb: getRandomAccentRGB()
                    };
                });
                
                AURA_MAP = results;
                renderHomePageWidgets(); 

            } catch (error) {
                console.error("Errore:", error);
                if(container) container.innerHTML = `<p class="text-center text-red-400">Errore: ${error.message}</p>`;
                AURA_MAP = [];
            }
        }
        
        function getRandomAccentColor() {
            const colors = ['#00BFFF', '#34D399', '#FCD34D', '#FF007F', '#8B5CF6']; 
            return colors[Math.floor(Math.random() * colors.length)];
        }
        function getRandomAccentRGB() {
            const rgbs = ['0 191 255', '52 211 153', '252 211 77', '255 0 127', '139 92 246'];
            return rgbs[Math.floor(Math.random() * rgbs.length)];
        }
        function getTrackMood() {
            const moods = ALL_MOODS;
            return moods[Math.floor(Math.random() * moods.length)];
        }
        
        function getMoodIcon(mood) {
            switch (mood) {
                case "Invernale": return "snowflake"; 
                case "Party": return "sparkles";
                case "Ambient": return "cloud-drizzle";
                case "Chill": return "cloud-snow"; 
                default: return "music";
            }
        }
        
        function updateListeningHistory(trackId) {
            listeningHistory = listeningHistory.filter(id => id !== trackId);
            listeningHistory.unshift(trackId);
            listeningHistory = listeningHistory.slice(0, 50);
            localStorage.setItem('aura_listening_history', JSON.stringify(listeningHistory));
        }


        // --- AUTH ---
        function openAuthModal(mode) {
             document.getElementById('auth-modal').classList.remove('hidden');
             switchAuthMode(mode);
        }
        function closeAuthModal() {
             document.getElementById('auth-modal').classList.add('hidden');
        }
        function switchAuthMode(mode) {
            const title = document.getElementById('auth-title');
            const button = document.getElementById('auth-main-button');
            const link = document.getElementById('auth-switch-link');
            
            if (mode === 'login') {
                title.textContent = 'Accedi ad Aura Music';
                button.textContent = 'Accedi';
                button.onclick = () => handleAuthAction('login');
                link.textContent = 'Registrati';
                link.onclick = () => switchAuthMode('register');
            } else {
                title.textContent = 'Registrati ad Aura Music';
                button.textContent = 'Registrati';
                button.onclick = () => handleAuthAction('register');
                link.textContent = 'Accedi';
                link.onclick = () => switchAuthMode('login');
            }
        }
        function handleAuthAction(mode) {
            const email = document.getElementById('auth-email').value;
            const password = document.getElementById('auth-password').value;
            
            if (!email || !password) {
                showToast("Inserisci email e password.", 'error');
                return;
            }
            
            if (mode === 'register') {
                 loggedInUser = { email: email, vibeScore: 0 };
                 showToast("Registrazione Eseguita!", 'success');
            } else {
                 loggedInUser = { email: email, vibeScore: 50 }; 
                 showToast("Accesso Eseguito!", 'success');
            }
            
            saveLocalData();
            updateAuthUI(loggedInUser);
            closeAuthModal();
            showSection('profile'); 
        }

        function handleLogout() {
            loggedInUser = null;
            saveLocalData();
            updateAuthUI(null);
            showToast("Disconnessione Eseguita.", 'info');
            showSection('music');
        }
        
        // --- FUNZIONI PROFILO ARTISTA E ALBUM ---
        
        function openArtistProfile(artistId) {
            const artist = ARTISTS_DATA.find(a => a.id === artistId);
            
            if (!artist) {
                showToast("Profilo artista non trovato.", "error");
                return;
            }

            document.getElementById('artist-modal-name').textContent = artist.name;
            document.getElementById('artist-modal-bio').textContent = artist.bio || "Nessuna biografia disponibile.";
            document.getElementById('artist-modal-genre').textContent = artist.genre || "Artista";
            
            const imgEl = document.getElementById('artist-modal-image');
            imgEl.src = artist.imageUrl || FALLBACK_COVER_URL;

            const socialContainer = document.getElementById('artist-modal-socials');
            socialContainer.innerHTML = ''; 
            
            if (artist.socials && artist.socials.instagram) {
                socialContainer.innerHTML += `
                    <a href="${artist.socials.instagram}" target="_blank" class="flex items-center space-x-2 px-4 py-2 rounded-full bg-gradient-to-r from-pink-600 to-purple-600 text-white font-bold hover:scale-105 transition shadow-lg">
                        <i data-lucide="instagram" class="w-5 h-5"></i>
                        <span>Instagram</span>
                    </a>
                `;
            }
            
            document.getElementById('artist-modal').classList.remove('hidden');
            lucide.createIcons();
        }

        function closeArtistModal() {
            document.getElementById('artist-modal').classList.add('hidden');
        }

        function openAlbumPage(albumId) {
            const albumTracks = AURA_MAP.filter(t => t.albumId === albumId);

            if (albumTracks.length === 0) {
                showToast("Album vuoto o non trovato.", "error");
                return;
            }

            const firstTrack = albumTracks[0];
            
            document.getElementById('album-modal-title').textContent = firstTrack.albumTitle || albumId;
            document.getElementById('album-modal-artist').textContent = firstTrack.artist;
            document.getElementById('album-modal-image').src = firstTrack.cover;

            const playAllBtn = document.getElementById('album-play-all');
            playAllBtn.onclick = function() {
                playTrack(firstTrack.id); 
            };

            const listContainer = document.getElementById('album-track-list');
            listContainer.innerHTML = albumTracks.map((track, index) => `
                <div onclick="playTrack('${track.id}')" class="flex items-center justify-between p-3 rounded-lg hover:bg-white/10 transition group cursor-pointer border-b border-white/5 last:border-0">
                    <div class="flex items-center space-x-3 overflow-hidden">
                        <span class="text-gray-500 font-mono text-sm w-6 text-center group-hover:text-accent-text">${index + 1}</span>
                        <div class="truncate">
                            <p class="text-white font-medium truncate group-hover:text-accent-text transition">${track.title}</p>
                            <p class="text-xs text-gray-500 truncate">${track.artist}</p>
                        </div>
                    </div>
                    <button class="text-gray-500 hover:text-white opacity-0 group-hover:opacity-100 transition">
                        <i data-lucide="play-circle" class="w-5 h-5"></i>
                    </button>
                </div>
            `).join('');

            document.getElementById('album-modal').classList.remove('hidden');
            lucide.createIcons();
        }

        function closeAlbumModal() {
            document.getElementById('album-modal').classList.add('hidden');
        }

        // --- PLAYBACK ---
        window.playTrack = function(trackId) {
            const track = AURA_MAP.find(t => t.id === trackId);
            if (!track) return;
            currentTrackData = track;
            updateListeningHistory(trackId);

            if (immersiveVideoPlayer) immersiveVideoPlayer.src = '';
            
            audioPlayer.src = track.audioUrl;
            audioPlayer.load();
            
            const attemptPlay = audioPlayer.play();
            if (attemptPlay && typeof attemptPlay.catch === 'function') {
                attemptPlay.catch(e => {
                    console.error("Autoplay Audio bloccato:", e);
                    togglePlayIcon(true);
                });
            }

            if (track.videoUrl) {
                 if (immersiveVideoPlayer) {
                     immersiveVideoPlayer.src = track.videoUrl;
                 }
            }
            
            setImmersiveVisual('cover');
            
            // Carica i testi se presenti
            if (track.lrcUrl) {
                loadLyrics(track.lrcUrl);
            } else {
                currentLyrics = [];
                updateLyricsUI(); // Questo nasconder√† il container
            }

            updateUI(track);
            if (playerBar) playerBar.classList.add('active');
        }

        window.togglePlayPause = function() {
            if (!audioPlayer) return;

            if (!currentTrackData) {
                if (AURA_MAP.length > 0) {
                    playTrack(AURA_MAP[0].id);
                } else {
                    showToast("Nessun brano caricato da riprodurre.", 'error');
                }
                return;
            }
            
            if (audioPlayer.paused) {
                audioPlayer.play();
            } else {
                audioPlayer.pause();
            }
        }

        window.skipForward = function() {
            if (!currentTrackData) return;
            const currentIndex = AURA_MAP.findIndex(t => t.id === currentTrackData.id);
            const nextIndex = (currentIndex + 1) % AURA_MAP.length;
            playTrack(AURA_MAP[nextIndex].id);
        }

        window.skipBackward = function() {
            if (!currentTrackData) return;
            const currentIndex = AURA_MAP.findIndex(t => t.id === currentTrackData.id);
            const prevIndex = (currentIndex - 1 + AURA_MAP.length) % AURA_MAP.length;
            playTrack(AURA_MAP[prevIndex].id);
        }

        window.toggleLoop = function() {
            isLooping = !isLooping;
            updateLoopButton(isLooping);
            saveLocalData();
            showToast(isLooping ? 'Ripetizione Attivata' : 'Ripetizione Disattivata', 'info');
        }

        function updateLoopButton(isLooping) {
            const loopButton = document.getElementById('loop-button-immersive'); 
            const loopIcon = loopButton.querySelector('i'); 
            
            if (loopButton && loopIcon) {
                loopIcon.setAttribute('data-lucide', isLooping ? 'repeat-one' : 'repeat');
                loopButton.classList.toggle('accent-text', isLooping); 
                loopButton.classList.toggle('text-white/70', !isLooping);
            }
            lucide.createIcons();
        }

        function updateProgress() {
            if (!audioPlayer || !progressBar || !progressBarImmersive) return;
            const duration = audioPlayer.duration;
            const currentTime = audioPlayer.currentTime;
            if (duration > 0) {
                const percentage = (currentTime / duration) * 100;
                progressBar.style.width = `${percentage}%`;
                progressBarImmersive.style.width = `${percentage}%`;
            }
            // Aggiorna scroll testi
            syncLyricsDisplay();
        }

        // --- Immersive Visuals ---
        function setImmersiveVisual(mode) {
            if(!currentTrackData) return;
            const icon = switchToVideoBtn ? switchToVideoBtn.querySelector('i') : null; 
            const videoAvailable = !!currentTrackData.videoUrl;
            
            if (mode === 'video' && videoAvailable && immersiveVideoPlayer) {
                isImmersiveVideoActive = true;
                immersiveCover.classList.add('hidden');
                immersiveVideoPlayer.classList.remove('hidden');
            } else {
                isImmersiveVideoActive = false;
                immersiveCover.classList.remove('hidden');
                if(immersiveVideoPlayer) immersiveVideoPlayer.classList.add('hidden');
            }

            if (videoAvailable) {
                if (switchToVideoBtn) switchToVideoBtn.classList.remove('hidden');
                if (switchToVideoPipBtn) switchToVideoPipBtn.classList.remove('hidden');
                if(icon) icon.setAttribute('data-lucide', isImmersiveVideoActive ? 'monitor-dot' : 'video');
            } else {
                 if (switchToVideoBtn) switchToVideoBtn.classList.add('hidden');
                 if (switchToVideoPipBtn) switchToVideoPipBtn.classList.add('hidden');
            }
            
            lucide.createIcons();
        }

        window.toggleImmersiveVisuals = function() {
            event.stopPropagation();
            if (!currentTrackData || !currentTrackData.videoUrl) return;

            const newMode = isImmersiveVideoActive ? 'cover' : 'video';
            setImmersiveVisual(newMode);
            
            if(newMode === 'cover') {
                if(immersiveVideoPlayer) immersiveVideoPlayer.src = ''; 
                audioPlayer.currentTime = 0;
                audioPlayer.play();
            } else {
                 if(immersiveVideoPlayer) immersiveVideoPlayer.src = currentTrackData.videoUrl;
                 audioPlayer.pause();
            }
        }
        
        window.enterImmersiveMode = function(preferredMode = 'audio') {
            if (!currentTrackData) {
                showToast("Seleziona un brano prima.", 'info');
                return;
            }
            document.getElementById('immersive-mode').classList.remove('hidden');
            document.body.style.overflow = 'hidden';
            updateProgress();
            
            if (preferredMode === 'video' && currentTrackData.videoUrl) {
                 toggleImmersiveVisuals(); 
            } else {
                 setImmersiveVisual('cover'); 
            }
        }

        window.exitImmersiveMode = function() {
            document.getElementById('immersive-mode').classList.add('hidden');
            document.body.style.overflow = 'auto';
        }

        function handleSeek(event) {
            if (!audioPlayer || !currentTrackData) return;
            const duration = audioPlayer.duration;
            if (duration <= 0) return;

            const container = event.currentTarget;
            const clickX = event.clientX - container.getBoundingClientRect().left;
            const width = container.offsetWidth;
            const seekTime = (clickX / width) * duration;
            audioPlayer.currentTime = seekTime;
        }

        function setupSeekListeners() {
            if(progressBarContainer) progressBarContainer.addEventListener('click', handleSeek);
            if(progressBarImmersiveContainer) progressBarImmersiveContainer.addEventListener('click', handleSeek);
        }
        
        function togglePlayIcon(isPaused) {
            const currentPlayIcon = document.getElementById('play-icon'); 
            const currentImmersivePlayIcon = document.getElementById('immersive-play-icon');

            if (currentPlayIcon) {
                currentPlayIcon.setAttribute('data-lucide', isPaused ? 'play' : 'pause');
            }
            if (currentImmersivePlayIcon) {
                currentImmersivePlayIcon.setAttribute('data-lucide', isPaused ? 'play' : 'pause');
            }
            
            checkMarqueeStatus(isPaused);
            lucide.createIcons();
        }
        
        function checkMarqueeStatus(isPaused) {
            if (!playerTitleWrapper || !immersiveTitleWrapper) return;

            setTimeout(() => {
                try {
                    playerTitleWrapper.classList.toggle('is-long', !isPaused);
                    immersiveTitleWrapper.classList.toggle('is-long', !isPaused);
                } catch (e) {
                    console.error("Errore Marquee:", e);
                }
            }, 50); 
        }


        function updateUI(track) {
            // Titoli con Marquee
            if (!playerTitle.querySelector('.marquee')) {
                playerTitle.innerHTML = `<span class="marquee">${track.title}</span>`;
            } else {
                playerTitle.querySelector('.marquee').textContent = track.title;
            }
            if (!immersiveTitle.querySelector('.marquee')) {
                immersiveTitle.innerHTML = `<span class="marquee">${track.title}</span>`;
            } else {
                immersiveTitle.querySelector('.marquee').textContent = track.title;
            }

            // AGGIORNAMENTO NOME ARTISTA CLICCABILE
            if (track.artistId) {
                const artistHtml = `<span onclick="event.stopPropagation(); openArtistProfile('${track.artistId}')" class="cursor-pointer hover:underline hover:text-white transition">${track.artist}</span>`;
                playerArtist.innerHTML = artistHtml;
                immersiveArtist.innerHTML = artistHtml;
            } else {
                playerArtist.textContent = track.artist;
                immersiveArtist.textContent = track.artist;
            }

            playerCover.src = track.cover;
            immersiveCover.src = track.cover;

            vibeScoreDisplay.textContent = `Vibe Score: ${track.vibe}/100`;

            updateAmbientLight(track.color || '#00BFFF', track.rgb || '0 191 255');
            updateLikeButton(track.id);
            setImmersiveVisual(isImmersiveVideoActive ? 'video' : 'cover'); 
            checkMarqueeStatus(audioPlayer.paused);
            togglePlayIcon(audioPlayer.paused);
            lucide.createIcons();
        }

        function updateAmbientLight(hexColor, rgbColor) {
            if (hexColor) {
                document.documentElement.style.setProperty('--ryzn-color-hex', hexColor);
            }
            if (rgbColor) {
                document.documentElement.style.setProperty('--ryzn-color-rgb', rgbColor);
            }
            lucide.createIcons(); 
        }

        function toggleLike(trackId = currentTrackData ? currentTrackData.id : null) {
            if (!trackId) {
                showToast("Seleziona un brano prima di mettere 'Mi Piace'.", 'info');
                return;
            }
            
            let message;
            if (likedTracks.has(trackId)) {
                likedTracks.delete(trackId);
                message = "Rimosso dai brani salvati.";
            } else {
                likedTracks.add(trackId);
                message = "Aggiunto ai brani salvati!";
            }
            
            updateLikeButton(trackId);
            renderLikedTracks(); 
            saveLocalData();
            showToast(message, 'info');
        }

        function updateLikeButton(trackId) {
            const isLiked = likedTracks.has(trackId);
            
            const button = document.getElementById('like-button');
            if (button) {
                button.classList.toggle('text-red-400', isLiked);
                button.classList.toggle('text-white/50', !isLiked);
            }

            const buttonImmersive = document.getElementById('like-button-immersive');
            if (buttonImmersive) {
                buttonImmersive.classList.toggle('text-red-400', isLiked);
                buttonImmersive.classList.toggle('text-white/70', !isLiked);
            }
        }

        // --- Widgets & Rendering ---

        function getQuickAccessTrackCard(track) {
            return `
                <div onclick="playTrack('${track.id}')" class="depth-glass p-2 rounded-lg cursor-pointer transition hover:scale-[1.02] border border-transparent hover:accent-border flex items-center space-x-3">
                    <img src="${track.cover}" alt="${track.title}" class="w-12 h-12 rounded-lg object-cover flex-shrink-0">
                    <p class="text-white font-bold truncate text-sm">${track.title}</p>
                </div>
            `;
        }

        function getTrackElement(track, layoutType) {
            const containerClasses = layoutType === 'horizontal-scroll' ? 'horizontal-widget-item' : 'w-full';
            const coverClasses = layoutType === 'horizontal-scroll' ? 'w-full h-auto aspect-square rounded-xl' : 'w-16 h-16 rounded-lg';
            const contentClasses = layoutType === 'horizontal-scroll' ? 'text-center mt-2' : 'flex-grow truncate';
            
            const buttonHtml = layoutType === 'horizontal-scroll' ? 
                `<button onclick="event.stopPropagation(); playTrack('${track.id}')" class="p-2 accent-bg rounded-full hover:scale-110 transition shadow-lg shadow-ryzn-accent/50 absolute bottom-3 right-3 opacity-0 group-hover:opacity-100"><i data-lucide="play" class="w-5 h-5 text-ryzn-bg fill-ryzn-bg"></i></button>` : 
                `<i data-lucide="play" class="w-5 h-5 accent-text"></i>`;

            const contentHtml = layoutType === 'horizontal-scroll' ? 
                ` <p class="font-bold truncate text-white">${track.title}</p> <p class="text-sm text-gray-400 truncate">${track.artist}</p> ` : 
                ` <div class="truncate"> <p class="font-bold text-white truncate">${track.title}</p> <p class="text-sm text-gray-400 truncate">${track.artist}</p> </div> `;

            const coverContainerHtml = layoutType === 'horizontal-scroll' ?
                `<div class="relative group">
                    <img src="${track.cover}" alt="${track.title}" class="${coverClasses} object-cover">
                    ${buttonHtml}
                 </div>` :
                `<img src="${track.cover}" alt="${track.title}" class="${coverClasses} object-cover flex-shrink-0">`;
            
            const outerClasses = layoutType === 'horizontal-scroll' ? 
                `${containerClasses} cursor-pointer hover:scale-[1.05] transition-transform` : 
                `${containerClasses} depth-glass p-3 rounded-xl flex items-center space-x-4 cursor-pointer hover:bg-white/10 transition`;

            return `
                <div onclick="playTrack('${track.id}')" class="${outerClasses}">
                    ${coverContainerHtml}
                    <div class="${contentClasses}">
                        ${contentHtml}
                    </div>
                    ${layoutType !== 'horizontal-scroll' ? buttonHtml : ''}
                </div>
            `;
        }
        
        // MODIFICATO: GRIGLIA 2x2 SU MOBILE
        function getPromoBannerHtml() {
             const bestTracks = AURA_MAP.filter(t => t.categoryID === 'Ryzn Best').slice(0, 4);
             if (bestTracks.length === 0) return '';
             
             const cardsHtml = bestTracks.map(track => `
                <div onclick="playTrack('${track.id}')" class="bg-white/10 backdrop-blur-md p-2 sm:p-3 rounded-xl flex items-center space-x-2 sm:space-x-3 cursor-pointer hover:bg-white/20 transition group">
                    <img src="${track.cover}" class="w-10 h-10 sm:w-12 sm:h-12 rounded-lg object-cover shadow-lg flex-shrink-0">
                    <div class="min-w-0">
                        <p class="font-bold text-white text-xs sm:text-sm truncate">${track.title}</p>
                        <p class="text-[10px] sm:text-xs text-white/70 truncate">RYZN Music Group</p>
                    </div>
                </div>
             `).join('');

             return `
                <div class="promo-banner">
                    <h3 class="promo-title">Ryzn Top 4 (Demo)</h3>
                    <div class="grid grid-cols-2 gap-2 sm:gap-4">
                        ${cardsHtml}
                    </div>
                    <div id="promo-countdown-text" class="promo-countdown"></div>
                </div>
             `;
        }


        function getMoodGridHtml() {
            return ALL_MOODS.map(mood => {
                const style = MOOD_STYLES[mood];
                const icon = getMoodIcon(mood);
                return `
                    <div onclick="showMoodTracks('${mood}')" class="depth-glass p-4 rounded-xl text-center cursor-pointer transition hover:bg-white/10 border border-white/10 ${style}">
                        <i data-lucide="${icon}" class="w-8 h-8 mx-auto mb-2"></i>
                        <p class="font-bold">${mood}</p>
                    </div>
                `;
            }).join('');
        }

        function renderHomePageWidgets() {
            const container = document.getElementById('home-widgets-container');
            if (!container) return;

            if (AURA_MAP.length === 0) {
                 if(container.innerHTML.indexOf('Errore nel caricamento') === -1) {
                    container.innerHTML = '<p class="text-center text-gray-500 col-span-full">Nessun brano caricato. Riprova pi√π tardi.</p>';
                 }
                return;
            }

            let allWidgetsHtml = '';

            if (activeFilter !== 'Trending') {
                const filteredTracks = AURA_MAP.filter(t => t.mood === activeFilter);
                const filteredHtml = filteredTracks.map(t => getTrackElement(t, 'grid')).join('');
                const backButtonHtml = `
                    <button onclick="showSection('music', 'Trending')" class="flex items-center text-gray-400 hover:accent-text transition mb-6">
                        <i data-lucide="arrow-left" class="w-6 h-6 mr-2"></i> Torna alla Home
                    </button>
                `;
                container.innerHTML = backButtonHtml + createWidgetBlock(`Risultati: ${activeFilter}`, 'Brani filtrati in base al mood selezionato.', filteredHtml, 'grid-cols-1 md:grid-cols-2 lg:grid-cols-3');
                lucide.createIcons();
                return;
            }
            
            allWidgetsHtml += getPromoBannerHtml();

            const quickAccessTracks = AURA_MAP.slice(0, 4); 
            const quickAccessHtml = quickAccessTracks.map(getQuickAccessTrackCard).join('');
            allWidgetsHtml += createWidgetBlock('üéß Accesso Rapido', 'Riclicca per un nuovo brano.', quickAccessHtml, 'grid-cols-2 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4');

            const moodGridHtml = getMoodGridHtml();
            allWidgetsHtml += createWidgetBlock('‚ú® Mood Select', 'Scegli la vibe perfetta per il tuo momento.', moodGridHtml, 'grid-cols-2 md:grid-cols-4');
            
            const allCategoryTracks = [];
            CATEGORY_KEYS.forEach(categoryID => {
                const categoryInfo = CATEGORY_MAP[categoryID];
                const categoryTracks = AURA_MAP.filter(t => t.categoryID === categoryID);
                allCategoryTracks.push(...categoryTracks);

                if (categoryTracks.length > 0) {
                    const shuffledTracks = [...categoryTracks] 
                        .sort(() => 0.5 - Math.random())
                        .slice(0, 10);
                    const tracksHtml = shuffledTracks.map(t => getTrackElement(t, 'horizontal-scroll')).join('');
                    
                    allWidgetsHtml += createWidgetBlock(
                        categoryInfo.title,
                        categoryInfo.subtitle,
                        tracksHtml,
                        'horizontal-scroll' 
                    );
                }
            });

            const popularTracks = [...allCategoryTracks]
                .sort(() => 0.5 - Math.random())
                .slice(0, 15);
            
            const popularTracksHtml = popularTracks.map(t => getTrackElement(t, 'horizontal-scroll')).join('');
            
            if (popularTracksHtml) {
                allWidgetsHtml += createWidgetBlock(
                    'üî• I Pi√π Ascoltati', 
                    'Una selezione casuale tra tutte le nostre sessioni pi√π popolari.', 
                    popularTracksHtml, 
                    'horizontal-scroll'
                );
            }

            container.innerHTML = allWidgetsHtml;
            lucide.createIcons();
            
            // AVVIA IL COUNTDOWN DOPO AVER RENDERIZZATO
            startCountdownTicker();
        }
        
        // --- FUNZIONE COUNTDOWN ---
        function startCountdownTicker() {
             const el = document.getElementById('promo-countdown-text');
             if(!el) return;

             function update() {
                 const now = new Date();
                 // Target: 24 Dicembre dell'anno corrente
                 let target = new Date(now.getFullYear(), 11, 24); // 11 √® Dicembre
                 
                 // Se oggi √® gi√† passato il 24 Dicembre, punta all'anno prossimo
                 if (now.getMonth() === 11 && now.getDate() > 24) {
                     target.setFullYear(target.getFullYear() + 1);
                 }

                 const diff = target - now;
                 
                 if (diff <= 0) {
                     el.textContent = "√à la Vigilia di Natale!";
                     return;
                 }

                 const days = Math.floor(diff / (1000 * 60 * 60 * 24));
                 const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                 const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
                 const seconds = Math.floor((diff % (1000 * 60)) / 1000);

                 el.textContent = `Mancano: ${days}g ${hours}h ${minutes}m ${seconds}s al 24 Dicembre`;
             }

             update(); // Esegui subito
             if(window.promoInterval) clearInterval(window.promoInterval);
             window.promoInterval = setInterval(update, 1000);
        }

        function getLikedTrackElement(track) {
            return `
                <div onclick="playTrack('${track.id}')" class="depth-glass p-3 rounded-xl flex items-center space-x-4 cursor-pointer hover:bg-white/10 transition">
                    <img src="${track.cover}" alt="${track.title}" class="w-12 h-12 rounded-lg object-cover flex-shrink-0">
                    <div class="truncate flex-grow">
                        <p class="font-bold text-white truncate">${track.title}</p>
                        <p class="text-sm text-gray-400 truncate">${track.artist}</p>
                    </div>
                    <button onclick="event.stopPropagation(); toggleLike('${track.id}')" class="text-red-400 hover:text-red-500 transition flex-shrink-0">
                        <i data-lucide="heart" class="w-5 h-5 fill-current"></i>
                    </button>
                </div>
            `;
        }

        function renderLikedTracks() {
            const listContainer = document.getElementById('liked-tracks-list');
            if (!listContainer) return;

            const tracks = AURA_MAP.filter(t => likedTracks.has(t.id));
            
            if (tracks.length === 0) {
                listContainer.innerHTML = '<p class="text-center p-4 text-gray-500">Nessun brano salvato.</p>';
                return;
            }

            const tracksHtml = tracks.map(getLikedTrackElement).join('');
            listContainer.innerHTML = tracksHtml;
            lucide.createIcons();
        }

        function createWidgetBlock(title, subtitle, contentHtml, gridClasses) {
            const isHorizontal = gridClasses === 'horizontal-scroll';
            const contentClasses = isHorizontal ? 'horizontal-scroll' : `grid gap-4 ${gridClasses}`;
            
            return `
                <div class="mb-10">
                    <h3 class="text-2xl font-bold mb-2">${title}</h3>
                    <p class="text-gray-400 mb-6">${subtitle}</p>
                    <div class="${contentClasses}">
                        ${contentHtml}
                    </div>
                </div>
            `;
        }

        window.showMoodTracks = function(mood) {
            showSection('music', mood);
        }

        // --- Playlists ---
        function generatePlaylistId() {
            return 'pl_' + Date.now();
        }

        function openCreatePlaylistModal() {
            document.getElementById('create-playlist-modal').classList.remove('hidden');
            document.getElementById('playlist-name-input').value = '';
        }

        function closeCreatePlaylistModal() {
            document.getElementById('create-playlist-modal').classList.add('hidden');
        }

        function createPlaylist() {
            const name = document.getElementById('playlist-name-input').value.trim();
            if (name.length < 3) {
                showToast("Il nome deve contenere almeno 3 caratteri.", 'error');
                return;
            }
            userPlaylists.push({
                id: generatePlaylistId(),
                name: name,
                tracks: []
            });
            saveLocalData();
            showToast(`Sessione "${name}" creata!`, 'success');
            closeCreatePlaylistModal();
            renderPlaylists();
        }

        function deletePlaylist(playlistId) {
            userPlaylists = userPlaylists.filter(p => p.id !== playlistId);
            saveLocalData();
            showToast("Sessione eliminata.", 'info');
            renderPlaylists();
        }

        function openAddToPlaylistModal(trackId = currentTrackData ? currentTrackData.id : null) {
            if (!trackId) {
                showToast("Nessun brano in riproduzione da aggiungere.", 'error');
                return;
            }
            trackIdToAdd = trackId;
            const listContainer = document.getElementById('playlist-selection-list');
            listContainer.innerHTML = userPlaylists.length === 0 ? 
                '<p class="text-center text-gray-500">Nessuna sessione trovata. <br> <button onclick="closeAddToPlaylistModal(); openCreatePlaylistModal()" class="accent-text hover:underline mt-2">Creane una ora.</button></p>' : 
                userPlaylists.map(playlist => {
                    const trackExists = playlist.tracks.includes(trackId);
                    const icon = trackExists ? 'check' : 'plus';
                    const text = trackExists ? 'Gi√† Aggiunto' : 'Aggiungi';
                    const color = trackExists ? 'text-green-400' : 'text-white/70 hover:text-white';
                    
                    return `
                        <div onclick="toggleTrackInPlaylist('${playlist.id}', '${trackId}')" class="flex items-center justify-between p-3 depth-glass rounded-lg cursor-pointer hover:bg-white/10 transition">
                            <span class="truncate">${playlist.name}</span>
                            <span class="flex items-center text-sm font-semibold ${color}">
                                ${text} <i data-lucide="${icon}" class="w-4 h-4 ml-1"></i>
                            </span>
                        </div>
                    `;
                }).join('');
            
            document.getElementById('add-to-playlist-modal').classList.remove('hidden');
            lucide.createIcons();
        }

        function closeAddToPlaylistModal() {
             document.getElementById('add-to-playlist-modal').classList.add('hidden');
        }

        window.toggleTrackInPlaylist = function(playlistId, trackId) {
            const playlist = userPlaylists.find(p => p.id === playlistId);
            const track = AURA_MAP.find(t => t.id === trackId);
            if (!track) return;

            let message = '';
            if (playlist.tracks.includes(trackId)) {
                playlist.tracks = playlist.tracks.filter(t => t !== trackId);
                message = `Rimosso: ${track.title} da ${playlist.name}`;
            } else {
                playlist.tracks.push(trackId);
                message = `Aggiunto: ${track.title} a ${playlist.name}`;
            }

            saveLocalData();
            showToast(message, 'success');
            closeAddToPlaylistModal();
            renderPlaylists();
        }

        function renderPlaylists() {
            const listContainer = document.getElementById('playlists-list');
            if (!listContainer) return;

            if (userPlaylists.length === 0) {
                listContainer.innerHTML = '<p class="text-center p-4 text-gray-500 col-span-full">Nessuna sessione creata.</p>';
                return;
            }

            const playlistsHtml = userPlaylists.map(playlist => {
                const trackCount = playlist.tracks.length;
                const covers = playlist.tracks.slice(0, 4).map(trackId => {
                    const track = AURA_MAP.find(t => t.id === trackId);
                    return track ? track.cover : FALLBACK_COVER_URL;
                });

                return `
                    <div class="depth-glass p-4 rounded-xl space-y-3 flex flex-col justify-between cursor-pointer transition hover:bg-white/10 relative">
                        <div>
                            <h3 class="text-xl font-bold accent-text truncate">${playlist.name}</h3>
                            <p class="text-sm text-gray-400 mb-3">${trackCount} brani</p>
                        </div>
                        <div onclick="event.stopPropagation(); playPlaylist('${playlist.id}')" class="flex items-center justify-between">
                            <div class="grid grid-cols-2 gap-1 w-24 aspect-square rounded-lg overflow-hidden flex-shrink-0 bg-black/20">
                                ${covers.map(cover => `<img src="${cover}" alt="Cover" class="w-full h-full object-cover">`).join('')}
                                ${Array(4 - covers.length).fill('<div class="w-full h-full bg-white/5"></div>').join('')}
                            </div>
                            <button onclick="event.stopPropagation(); playPlaylist('${playlist.id}')" class="p-3 accent-bg rounded-full hover:scale-110 transition shadow-lg shadow-ryzn-accent/50 ml-4">
                                <i data-lucide="play" class="w-6 h-6 text-ryzn-bg fill-ryzn-bg"></i>
                            </button>
                        </div>
                        <button onclick="event.stopPropagation(); deletePlaylist('${playlist.id}')" class="absolute top-3 right-3 text-gray-500 hover:text-red-500 transition">
                            <i data-lucide="trash-2" class="w-5 h-5"></i>
                        </button>
                    </div>
                `;
            }).join('');
            
            listContainer.innerHTML = playlistsHtml;
            lucide.createIcons();
        }

        window.playPlaylist = function(playlistId) {
            const playlist = userPlaylists.find(p => p.id === playlistId);
            if (!playlist || playlist.tracks.length === 0) {
                showToast("La sessione √® vuota.", 'error');
                return;
            }
            playTrack(playlist.tracks[0]);
            showToast(`Avviata sessione: ${playlist.name}`, 'info');
            showSection('music');
        }
        
        // --- UI Generica ---

        function showSection(sectionId, filter = 'Trending') {
            const sections = document.querySelectorAll('.section-page');
            sections.forEach(sec => sec.classList.remove('active'));
            
            const targetSection = document.getElementById(sectionId + '-section');
            if (targetSection) {
                targetSection.classList.add('active');
            }
            
            activeFilter = filter;
            if (sectionId === 'music') {
                renderHomePageWidgets(); 
            } else if (sectionId === 'library') {
                renderLikedTracks();
            } else if (sectionId === 'playlists') {
                renderPlaylists();
            } else if (sectionId === 'profile') {
                if (vibeScoreDisplay && loggedInUser) {
                    vibeScoreDisplay.textContent = `Vibe Score: ${loggedInUser.vibeScore}/100`;
                }
            }
            
            const greeting = document.getElementById('home-greeting');
            if (greeting) {
                const hour = new Date().getHours();
                if (hour >= 5 && hour < 13) {
                    greeting.textContent = 'Buongiorno. La tua Vibe √® pronta.';
                } else if (hour >= 13 && hour < 18) {
                    greeting.textContent = 'Buon Pomeriggio. La tua Vibe √® pronta.';
                } else {
                    greeting.textContent = 'Buonasera. La tua Vibe √® pronta.';
                }
            }
        }
        
        function openSearchModal() {
            document.getElementById('search-modal').classList.remove('hidden');
            document.getElementById('search-results').innerHTML = '<p class="text-center text-gray-500">Inizia a digitare per cercare nella libreria locale.</p>';
            document.getElementById('search-input').value = '';
            document.getElementById('search-input').focus();
        }

        function closeSearchModal() {
            document.getElementById('search-modal').classList.add('hidden');
        }

        function performSearch() {
            const query = document.getElementById('search-input').value.toLowerCase().trim();
            const resultsContainer = document.getElementById('search-results');
            
            if (query.length < 2) {
                resultsContainer.innerHTML = '<p class="text-center text-gray-500">Inizia a digitare...</p>';
                return;
            }

            let htmlContent = '';

            // 1. Cerca Artisti
            const foundArtists = ARTISTS_DATA.filter(artist => 
                artist.name.toLowerCase().includes(query)
            );

            if (foundArtists.length > 0) {
                htmlContent += `<h4 class="text-xs font-bold text-gray-400 uppercase mb-2 mt-2 sticky top-0 bg-ryzn-bg/90 backdrop-blur p-2 z-10">Artisti</h4>`;
                htmlContent += foundArtists.map(artist => `
                    <div onclick="openArtistProfile('${artist.id}'); closeSearchModal();" class="flex items-center space-x-3 p-3 rounded-xl bg-white/5 hover:bg-white/10 cursor-pointer transition mb-2 border border-white/5">
                        <img src="${artist.imageUrl || FALLBACK_COVER_URL}" alt="${artist.name}" class="w-12 h-12 rounded-full object-cover border border-white/10">
                        <div>
                            <p class="font-bold text-white text-base">${artist.name}</p>
                            <p class="text-xs text-gray-400">Artista</p>
                        </div>
                    </div>
                `).join('');
            }

            // 2. Cerca Album
            const uniqueAlbums = {};
            AURA_MAP.forEach(track => {
                if (track.albumId) {
                    if (!uniqueAlbums[track.albumId]) {
                        uniqueAlbums[track.albumId] = {
                            id: track.albumId,
                            title: track.albumTitle || track.albumId, 
                            artist: track.artist,
                            cover: track.cover
                        };
                    }
                }
            });

            const foundAlbums = Object.values(uniqueAlbums).filter(album => 
                album.title.toLowerCase().includes(query)
            );

            if (foundAlbums.length > 0) {
                htmlContent += `<h4 class="text-xs font-bold text-gray-400 uppercase mb-2 mt-4 sticky top-0 bg-ryzn-bg/90 backdrop-blur p-2 z-10">Album</h4>`;
                htmlContent += foundAlbums.map(album => `
                    <div onclick="openAlbumPage('${album.id}'); closeSearchModal();" class="flex items-center space-x-3 p-3 rounded-xl bg-white/5 hover:bg-white/10 cursor-pointer transition mb-2 border border-white/5">
                        <img src="${album.cover}" alt="${album.title}" class="w-12 h-12 rounded-md object-cover shadow-md">
                        <div class="truncate">
                            <p class="font-bold text-white text-base truncate">${album.title}</p>
                            <p class="text-xs text-gray-400 truncate">Album ‚Ä¢ ${album.artist}</p>
                        </div>
                        <i data-lucide="chevron-right" class="w-5 h-5 text-gray-500 ml-auto"></i>
                    </div>
                `).join('');
            }

            // 3. Cerca Brani
            const foundTracks = AURA_MAP.filter(track => 
                track.title.toLowerCase().includes(query) || 
                track.artist.toLowerCase().includes(query)
            );

            if (foundTracks.length > 0) {
                htmlContent += `<h4 class="text-xs font-bold text-gray-400 uppercase mb-2 mt-4 sticky top-0 bg-ryzn-bg/90 backdrop-blur p-2 z-10">Brani</h4>`;
                htmlContent += foundTracks.map(track => `
                    <div onclick="playTrack('${track.id}'); closeSearchModal();" class="flex items-center space-x-3 p-2 rounded-lg hover:bg-white/10 cursor-pointer transition">
                        <img src="${track.cover}" alt="${track.title}" class="w-10 h-10 rounded-md object-cover">
                        <div class="truncate flex-grow">
                            <p class="font-bold text-white truncate text-sm">${track.title}</p>
                            <p class="text-xs text-gray-400 truncate">${track.artist}</p>
                        </div>
                    </div>`
                ).join('');
            }

            if (foundArtists.length === 0 && foundAlbums.length === 0 && foundTracks.length === 0) {
                resultsContainer.innerHTML = `<p class="text-center text-gray-500">Nessun risultato per "${query}".</p>`;
            } else {
                resultsContainer.innerHTML = htmlContent;
                lucide.createIcons();
            }
        }


        // --- Storage & Init ---

        function loadLocalData() {
            const liked = localStorage.getItem('aura_liked_tracks');
            if (liked) likedTracks = new Set(JSON.parse(liked));
            
            const playlists = localStorage.getItem('aura_user_playlists');
            if (playlists) userPlaylists = JSON.parse(playlists);
            
            const user = localStorage.getItem('aura_logged_in_user');
            if (user) loggedInUser = JSON.parse(user);
            
            const history = localStorage.getItem('aura_listening_history');
            if (history) listeningHistory = JSON.parse(history);
            
            updateAuthUI(loggedInUser);
        }

        function saveLocalData() {
            localStorage.setItem('aura_liked_tracks', JSON.stringify(Array.from(likedTracks)));
            localStorage.setItem('aura_user_playlists', JSON.stringify(userPlaylists));
            localStorage.setItem('aura_logged_in_user', JSON.stringify(loggedInUser));
            localStorage.setItem('aura_listening_history', JSON.stringify(listeningHistory));
        }

        function updateAuthUI(user) {
            const authButton = document.getElementById('auth-button-header');
            const profileInfo = document.getElementById('profile-info');

            if (authButton) {
                const icon = authButton.querySelector('i');
                if (user) {
                    icon.setAttribute('data-lucide', 'user-check');
                    authButton.classList.add('accent-border');
                    authButton.classList.add('border-2');
                    authButton.onclick = () => showSection('profile');
                } else {
                    icon.setAttribute('data-lucide', 'user');
                    authButton.classList.remove('accent-border');
                    authButton.classList.remove('border-2');
                    authButton.onclick = () => openAuthModal('login');
                }
            }

            if (profileInfo) {
                profileInfo.textContent = user ? `Utente: ${user.email}` : 'Stato: Disconnesso';
            }
        }

        function showToast(message, type = 'info') {
            const container = document.getElementById('toast-container');
            if (!container) return;

            const toast = document.createElement('div');
            let bgColor = 'bg-gray-700';
            let icon = 'info'; 

            if (type === 'success') {
                bgColor = 'bg-green-600';
                icon = 'check-circle';
            } else if (type === 'error') {
                bgColor = 'bg-red-600';
                icon = 'x-circle';
            } else if (type === 'info') {
                bgColor = 'bg-blue-600';
                icon = 'bell';
            }

            toast.className = `p-4 mb-3 rounded-lg text-white shadow-xl ${bgColor} flex items-center transition-all duration-300 transform translate-x-0 opacity-100`;
            toast.innerHTML = `<i data-lucide="${icon}" class="w-5 h-5 mr-3 flex-shrink-0"></i> <span>${message}</span>`;

            container.appendChild(toast);
            lucide.createIcons();

            setTimeout(() => {
                toast.classList.remove('opacity-100');
                toast.classList.add('opacity-0', 'translate-x-full');
                setTimeout(() => toast.remove(), 300);
            }, 5000);
        }

        function createSnowflakes() {
            const snowContainer = document.getElementById('snow-container');
            if (!snowContainer) return;
            const flakeCount = 50; 

            for (let i = 0; i < flakeCount; i++) {
                const flake = document.createElement('div');
                flake.className = 'flake';
                flake.textContent = '‚ùÖ'; 
                const startX = Math.random() * 110 - 10; 
                const size = Math.random() * 10 + 8; 
                const duration = Math.random() * 10 + 5; 
                const delay = Math.random() * 5; 

                flake.style.left = `${startX}vw`;
                flake.style.fontSize = `${size}px`;
                flake.style.animationDuration = `${duration}s`;
                flake.style.animationDelay = `${delay}s`;

                snowContainer.appendChild(flake);
            }
        }
        
        function getDOMElements() {
            audioPlayer = document.getElementById('audioPlayer');
            immersiveVideoPlayer = document.getElementById('immersive-video-player'); 
            
            switchToVideoBtn = document.getElementById('switch-to-video-btn'); 
            switchToVideoPipBtn = document.getElementById('switch-to-video-pip'); 

            progressBar = document.getElementById('progress-bar');
            progressBarImmersive = document.getElementById('progress-bar-immersive');
            playerTitle = document.getElementById('player-title');
            playerArtist = document.getElementById('player-artist');
            playerCover = document.getElementById('player-cover');
            playerBar = document.querySelector('.player-bar'); 

            immersiveCover = document.getElementById('immersive-cover');
            immersiveTitle = document.getElementById('immersive-title');
            immersiveArtist = document.getElementById('immersive-artist');
            loopButtonImmersive = document.getElementById('loop-button-immersive');
            
            vibeScoreDisplay = document.getElementById('vibe-score-display');
            progressBarContainer = document.getElementById('progress-bar-container');
            progressBarImmersiveContainer = document.getElementById('progress-bar-immersive-container');
            
            playerTitleWrapper = document.getElementById('player-title-wrapper');
            immersiveTitleWrapper = document.getElementById('immersive-title-wrapper');

            // ‚≠ê Riferimento Lyrics
            lyricsContainer = document.getElementById('lyrics-container');

            audioPlayer.addEventListener('play', onPlayerPlay);
            audioPlayer.addEventListener('pause', onPlayerPause);
            audioPlayer.addEventListener('timeupdate', updateProgress);
            audioPlayer.addEventListener('ended', onTrackEnded);

            setupSeekListeners();
        }

        function updateMediaSession() {
            if (!('mediaSession' in navigator) || !currentTrackData) return;

            const isPlaying = !audioPlayer.paused;
            
            navigator.mediaSession.setActionHandler('play', () => audioPlayer.play());
            navigator.mediaSession.setActionHandler('pause', () => audioPlayer.pause());
            navigator.mediaSession.setActionHandler('seekbackward', () => skipBackward());
            navigator.mediaSession.setActionHandler('seekforward', () => skipForward());
            navigator.mediaSession.setActionHandler('nexttrack', () => skipForward());
            navigator.mediaSession.setActionHandler('previoustrack', () => skipBackward());

            navigator.mediaSession.metadata = new MediaMetadata({
                title: currentTrackData.title,
                artist: currentTrackData.artist,
                album: currentTrackData.albumTitle || 'Aura Music Choice',
                 artwork: [
                     { src: currentTrackData.cover, sizes: '192x192', type: 'image/jpeg' },
                 ]
            });

            if ('setPositionState' in navigator.mediaSession) {
                 navigator.mediaSession.setPositionState({
                     duration: audioPlayer.duration || 0,
                     playbackRate: audioPlayer.playbackRate,
                     position: audioPlayer.currentTime || 0
                 });
            }
            
            navigator.mediaSession.playbackState = isPlaying ? 'playing' : 'paused';
        }


        async function initializeAppContent() {
            
            if ('serviceWorker' in navigator) {
                try {
                    const registration = await navigator.serviceWorker.register('./service_worker.js');
                    console.log('Service Worker registrato con successo:', registration);
                } catch (error) {
                    console.error('Registrazione Service Worker fallita:', error);
                }
            }

            loadLocalData();
            getDOMElements(); 
            createSnowflakes(); 
            
            await fetchTracks(); 
            
            updateAmbientLight('#00BFFF', '0 191 255'); 
            updateLoopButton(isLooping); 
            showSection('music'); 
            
             if (playerBar) playerBar.classList.remove('active'); 
        }

        document.addEventListener('DOMContentLoaded', initializeAppContent);
    </script>
</body>
</html>
