<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aura Music - (GitHub V8.6) Grafica Glaciale/Natale</title>
    
    <link rel="icon" href="https://via.placeholder.com/192x192">
    <link rel="apple-touch-icon" href="https://via.placeholder.com/192x192">
    <meta name="theme-color" content="#171717">

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <style>
        /* Variabili di Tema Dinamiche (Glaciale/Natale) */
        :root {
            --ryzn-color-hex: #00BFFF; /* Glacial Blue */
            --ryzn-color-rgb: 0 191 255;
            --ryzn-bg-color: #171717; 
            --ryzn-color-dark: 0 150 200; /* Darker blue shade */
        }

        /* Classi Tailwind Dinamiche */
        .ryzn-bg { background-color: var(--ryzn-bg-color); }
        .accent-text { color: var(--ryzn-color-hex); }
        .accent-bg { background-color: var(--ryzn-color-hex); }
        .accent-border { border-color: var(--ryzn-color-hex); }
        .accent-hover:hover { filter: brightness(1.2); }
        .shadow-ryzn-accent\/30 { box-shadow: 0 10px 15px -3px rgba(var(--ryzn-color-rgb) / 0.3), 0 4px 6px -2px rgba(var(--ryzn-color-rgb) / 0.1); }
        .fill-ryzn-accent\/30 { fill: rgba(var(--ryzn-color-rgb) / 0.3); }

        /* Effetto Glassmorphism (Depth-Glass) - FONDAMENTALE PER LA GRAFICA */
        .depth-glass {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        /* Stile Logo con Gradiente Dinamico (Palette Glaciale) */
        .logo-aura { font-size: 2.5rem; font-weight: 900; }
        .logo-text {
            /* Palette Glaciale: Da Blu Vivo a Bianco/Celeste */
            background: linear-gradient(45deg, var(--ryzn-color-hex), #B3E0FF); 
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-fill-color: transparent;
        }
        
        /* Nuove Transizioni per Icone */
        .animated-icon {
            transition: transform 0.2s ease, opacity 0.2s ease, fill 0.3s ease;
        }
        
        /* Contenitore Principale e Sezioni (Animazioni di Transizione) */
        body {
            background-color: var(--ryzn-bg-color);
            color: white;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            padding-bottom: 96px; 
            overflow-x: hidden;
        }

        .container-app {
            flex-grow: 1;
            padding: 1rem;
            max-width: 1400px;
            margin: 0 auto;
            width: 100%;
        }

        .section-page {
            display: none;
            opacity: 0;
            transition: opacity 0.5s ease; /* Transizione per le sezioni */
        }
        .section-page.active {
            display: block;
            opacity: 1;
        }
        
        /* Player Bar (PIP) */
        .player-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            height: 80px;
            z-index: 100;
            transform: translateY(100%);
            transition: transform 0.3s ease-out; /* Animazione di entrata */
        }
        .player-bar.active {
             transform: translateY(0);
        }
        
        /* Modal di Ricerca e Autenticazione */
        .modal {
            animation: fadeIn 0.3s ease-out; /* Animazione Modal */
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        /* Toast Container */
        #toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 200;
        }
        
        /* Player Audio HTML5 Nascosto */
        #audio-player-container {
            position: absolute;
            top: -9999px; 
            left: -9999px;
            width: 1px;
            height: 1px;
            overflow: hidden;
            opacity: 0;
        }
        
        /* Stili Snow (Neve che Cade) */
        .snow-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 9999;
            overflow: hidden;
        }
        .flake {
            position: absolute;
            top: -10%;
            color: white;
            font-size: 10px;
            opacity: 0.8;
            animation: fall linear infinite;
            text-shadow: 0 0 3px rgba(var(--ryzn-color-rgb) / 0.5); /* Lieve bagliore blu */
        }
        @keyframes fall {
            to {
                transform: translateY(100vh);
            }
        }

    </style>
</head>
<body class="ryzn-bg">

    <div id="snow-container" class="snow-container"></div>

    <div id="toast-container"></div>
    
    <div id="audio-player-container">
        <audio id="audioPlayer" playsinline></audio>
    </div>


    <div id="auth-modal" class="fixed inset-0 bg-black/70 backdrop-blur-sm z-[150] hidden flex items-center justify-center p-4 modal">
        <div class="depth-glass bg-ryzn-bg p-6 rounded-2xl w-full max-w-sm shadow-2xl relative">
            <h3 id="auth-title" class="text-2xl font-bold mb-6 accent-text text-center">Accedi ad Aura Music</h3>
            
            <input type="email" id="auth-email" placeholder="Email" class="w-full p-3 rounded-lg bg-white/10 border border-white/20 focus:accent-border text-white placeholder-gray-500 mb-3">
            <input type="password" id="auth-password" placeholder="Password" class="w-full p-3 rounded-lg bg-white/10 border border-white/20 focus:accent-border text-white placeholder-gray-500 mb-6">
            
            <button id="auth-main-button" onclick="handleAuthAction('login')" class="w-full py-3 accent-bg rounded-lg text-white font-bold accent-hover transition">Accedi</button>
            
            <div class="text-center mt-4">
                <button id="auth-switch-link" onclick="switchAuthMode('register')" class="text-sm text-gray-400 hover:accent-text transition">Registrati</button>
            </div>
             <button onclick="closeAuthModal()" class="absolute top-3 right-3 text-gray-400 hover:text-white transition"><i data-lucide="x" class="w-6 h-6"></i></button>
        </div>
    </div>
    
    <div id="search-modal" class="fixed inset-0 bg-black/70 backdrop-blur-sm z-[150] hidden flex flex-col p-4 modal">
        <div class="w-full max-w-2xl mx-auto depth-glass bg-ryzn-bg p-6 rounded-2xl shadow-2xl relative">
            <div class="flex items-center mb-4">
                <input type="text" id="search-input" oninput="performSearch()" placeholder="Cerca brani o artisti locali..." class="flex-grow p-3 rounded-l-lg bg-white/10 border border-white/20 text-white placeholder-gray-500 focus:outline-none">
                <button onclick="performSearch()" class="p-3 accent-bg rounded-r-lg accent-hover"><i data-lucide="search" class="w-6 h-6"></i></button>
            </div>
            <div id="search-results" class="max-h-96 overflow-y-auto space-y-3 p-2">
                <p class="text-center text-gray-500">Inizia a digitare per cercare nella libreria locale.</p>
            </div>
            <button onclick="closeSearchModal()" class="absolute top-3 right-3 text-gray-400 hover:text-white transition"><i data-lucide="x" class="w-6 h-6"></i></button>
        </div>
    </div>
    
    <div id="create-playlist-modal" class="fixed inset-0 bg-black/70 backdrop-blur-sm z-[150] hidden flex items-center justify-center p-4">
        <div class="depth-glass bg-ryzn-bg p-6 rounded-2xl w-full max-w-sm shadow-2xl relative">
            <h3 class="text-xl font-bold mb-4 accent-text">Crea Nuova Sessione</h3>
            <input type="text" id="playlist-name-input" placeholder="Nome della sessione" class="w-full p-3 rounded-lg bg-white/10 border border-white/20 focus:accent-border text-white placeholder-gray-500 mb-4">
            
            <div class="flex justify-end space-x-3">
                <button onclick="closeCreatePlaylistModal()" class="px-4 py-2 text-gray-400 hover:text-white transition rounded-lg">Annulla</button>
                <button onclick="createPlaylist()" class="px-4 py-2 accent-bg rounded-lg text-white font-bold accent-hover transition">Crea</button>
            </div>
            <button onclick="closeCreatePlaylistModal()" class="absolute top-3 right-3 text-gray-400 hover:text-white transition"><i data-lucide="x" class="w-6 h-6"></i></button>
        </div>
    </div>

    <div id="add-to-playlist-modal" class="fixed inset-0 bg-black/70 backdrop-blur-sm z-[150] hidden flex items-center justify-center p-4">
        <div class="depth-glass bg-ryzn-bg p-6 rounded-2xl w-full max-w-sm shadow-2xl relative">
            <h3 class="text-xl font-bold mb-4 accent-text">Aggiungi a Sessione</h3>
            <div id="playlist-selection-list" class="max-h-64 overflow-y-auto space-y-2 p-1">
                <p class="text-center text-gray-500">Nessuna sessione trovata.</p>
            </div>
            <button onclick="closeAddToPlaylistModal()" class="absolute top-3 right-3 text-gray-400 hover:text-white transition"><i data-lucide="x" class="w-6 h-6"></i></button>
        </div>
    </div>

    <div id="immersive-mode" onclick="exitImmersiveMode()" class="fixed inset-0 bg-black/90 backdrop-blur-xl z-[150] hidden flex-col items-center justify-center p-6 modal">
        
        <div class="absolute top-6 left-6 flex items-center space-x-4">
            <button onclick="exitImmersiveMode()" class="text-white/80 hover:text-white transition"><i data-lucide="chevron-down" class="w-8 h-8"></i></button>
            <h2 class="text-xl font-semibold">In Riproduzione</h2>
        </div>
        
        <div id="immersive-player-visual-container" class="w-full max-w-3xl aspect-video rounded-3xl shadow-2xl shadow-ryzn-accent/30 overflow-hidden bg-black flex items-center justify-center mb-8">
             <img id="immersive-cover" src="" alt="Album Cover" class="w-full h-full object-cover">
             <video id="immersive-video-player" src="" class="w-full h-full object-contain bg-black hidden" playsinline loop muted></video>
        </div>
        
        <div class="flex flex-col items-center space-y-8 max-w-lg w-full">
            <div class="text-center">
                <h3 id="immersive-title" class="text-4xl font-extrabold truncate">Titolo Brano</h3>
                <p id="immersive-artist" class="text-xl text-gray-400 truncate">Artista</p>
            </div>
            
            <button id="switch-to-video-btn" onclick="event.stopPropagation(); toggleImmersiveVisuals()" class="p-2 depth-glass rounded-full text-white hover:bg-white/10 transition hidden">
                <i data-lucide="video" class="w-6 h-6"></i>
            </button>

            <div id="progress-bar-immersive-container" class="w-full h-2 bg-white/20 rounded-full cursor-pointer relative">
                <div id="progress-bar-immersive" class="h-2 accent-bg rounded-full" style="width: 0;"></div>
            </div>

            <div class="flex space-x-8 items-center">
                <button id="loop-button-immersive" onclick="event.stopPropagation(); toggleLoop()" class="text-white/70 hover:text-white transition">
                    <i data-lucide="repeat" class="w-8 h-8"></i>
                </button>
                <button onclick="event.stopPropagation(); skipBackward()" class="text-white/70 hover:text-white transition">
                    <i data-lucide="skip-back" class="w-8 h-8 fill-current"></i>
                </button>
                <button onclick="event.stopPropagation(); togglePlayPause(true)" class="p-4 accent-bg rounded-full hover:scale-105 transition shadow-xl shadow-ryzn-accent/50">
                    <i id="immersive-play-icon" data-lucide="play" class="w-10 h-10 text-ryzn-bg fill-ryzn-bg animated-icon"></i> 
                </button>
                <button onclick="event.stopPropagation(); skipForward()" class="text-white/70 hover:text-white transition">
                    <i data-lucide="skip-forward" class="w-8 h-8 fill-current"></i>
                </button>
                <button onclick="event.stopPropagation(); toggleLike()" id="like-button-immersive" class="text-white/70 hover:text-red-400 transition">
                    <i data-lucide="heart" class="w-6 h-6 fill-current"></i>
                </button>
            </div>
        </div>
    </div>
    
    <div class="container-app">
        
        <header class="flex justify-between items-center mb-8">
            <div class="flex items-center space-x-8">
                <a href="#" onclick="showSection('music')" class="cursor-pointer">
                    <h1 class="logo-aura flex items-center space-x-2">
                        <i data-lucide="sparkles" class="w-7 h-7 accent-text fill-ryzn-accent/30"></i>
                        <span class="logo-text">Aura</span>
                    </h1>
                </a>
                <nav class="hidden sm:flex space-x-6 text-gray-400 text-lg font-medium">
                    <button id="nav-music" onclick="showSection('music')" class="nav-item hover:accent-text transition pb-1">Scopri</button>
                </nav>
            </div>
            
            <div class="flex items-center space-x-3">
                 <button onclick="showSection('playlists')" class="p-2 depth-glass rounded-full text-white hover:bg-white/10 transition">
                    <i data-lucide="list-music" class="w-6 h-6"></i>
                 </button>
                 <button onclick="showSection('library')" class="p-2 depth-glass rounded-full text-white hover:bg-white/10 transition">
                    <i data-lucide="heart" class="w-6 h-6 fill-current"></i>
                 </button>
                 <button onclick="openSearchModal()" class="p-2 depth-glass rounded-full text-white hover:bg-white/10 transition">
                    <i data-lucide="search" class="w-6 h-6"></i>
                 </button>
                 <button id="auth-button-header" onclick="loggedInUser ? showSection('profile') : openAuthModal('login')" class="p-2 depth-glass rounded-full text-white hover:bg-white/10 transition">
                    <i data-lucide="user" class="w-6 h-6"></i>
                 </button>
            </div>
        </header>
        
        <hr class="border-white/10 my-6 md:my-10">


        <section id="music-section" class="section-page active">
            <h2 id="home-greeting" class="text-4xl font-extrabold mb-8 text-white">Buonasera. La tua Vibe è pronta.</h2>
            <div id="home-widgets-container" class="space-y-10">
                <p class="text-center text-gray-400 col-span-full"><i data-lucide="loader-2" class="w-5 h-5 animate-spin inline-block mr-2"></i> Caricamento in corso...</p>
            </div>
        </section>
        <section id="library-section" class="section-page">
            <h2 class="text-3xl font-bold mb-6">I Tuoi Brani Salvati</h2>
            <div id="liked-tracks-list" class="space-y-3">
                <p class="text-center p-4 text-gray-500">Nessun brano salvato.</p>
            </div>
        </section>

        <section id="playlists-section" class="section-page">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-3xl font-bold">Le Tue Sessioni</h2>
                <button onclick="openCreatePlaylistModal()" class="flex items-center px-4 py-2 accent-bg rounded-full text-sm font-semibold accent-hover transition">
                    <i data-lucide="plus" class="w-4 h-4 mr-1"></i> Crea Sessione
                </button>
            </div>
            <div id="playlists-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                <p class="text-center p-4 text-gray-500 col-span-full">Nessuna sessione creata.</p>
            </div>
        </section>

        <section id="profile-section" class="section-page">
            <h2 class="text-3xl font-bold mb-6">Profilo Utente</h2>
            <div class="depth-glass p-6 rounded-xl max-w-lg space-y-4">
                <p id="profile-info" class="text-lg font-semibold">Stato: Disconnesso</p>
                <div id="vibe-score-display" class="text-xl accent-text font-bold">Vibe Score: 0/100</div>
                <button onclick="handleLogout()" class="px-4 py-2 bg-red-600 rounded-lg text-white font-bold hover:bg-red-700 transition">Disconnetti</button>
            </div>
        </section>

        </div> 
    
    <div onclick="enterImmersiveMode()" class="player-bar depth-glass bg-ryzn-bg/80 border-t border-white/10 flex items-center justify-between px-4 sm:px-8 cursor-pointer">
        
        <div class="flex items-center space-x-4 w-1/3">
            <img id="player-cover" src="https://via.placeholder.com/64" alt="Album Cover" class="w-12 h-12 rounded-md object-cover">
            <div class="truncate">
                <p id="player-title" class="font-bold truncate text-sm">Nessun Brano</p>
                <p id="player-artist" class="text-xs text-gray-400 truncate">Tocca per iniziare</p>
            </div>
        </div>

        <div class="flex items-center justify-center space-x-4 w-1/3">
            <button onclick="event.stopPropagation(); skipBackward()" class="text-white/70 hover:text-white transition hidden md:block">
                 <i data-lucide="skip-back" class="w-5 h-5 fill-current"></i>
            </button>
            <button onclick="event.stopPropagation(); togglePlayPause()" class="p-2 accent-bg rounded-full hover:scale-105 transition shadow-lg shadow-ryzn-accent/30">
                <i id="play-icon" data-lucide="play" class="w-6 h-6 text-ryzn-bg fill-ryzn-bg animated-icon"></i> 
            </button>
            <button onclick="event.stopPropagation(); skipForward()" class="text-white/70 hover:text-white transition hidden md:block">
                 <i data-lucide="skip-forward" class="w-5 h-5 fill-current"></i>
            </button>
        </div>

        <div class="flex items-center justify-end space-x-4 w-1/3">
            <button id="switch-to-video-pip" onclick="event.stopPropagation(); enterImmersiveMode('video')" class="text-white/50 hover:text-white transition hidden">
                <i data-lucide="monitor-dot" class="w-5 h-5"></i>
            </button>
            
            <button id="add-to-playlist-button" onclick="event.stopPropagation(); openAddToPlaylistModal()" class="text-white/50 hover:text-white transition hidden lg:block">
                <i data-lucide="list-plus" class="w-5 h-5"></i>
            </button>
            <button id="like-button" onclick="event.stopPropagation(); toggleLike()" class="text-white/50 hover:text-red-400 transition">
                <i data-lucide="heart" class="w-5 h-5 fill-current"></i>
            </button>
        </div>

        <div id="progress-bar-container" class="absolute bottom-0 left-0 w-full h-1 bg-transparent cursor-pointer">
            <div id="progress-bar" class="h-1 accent-bg" style="width: 0;"></div>
        </div>
    </div>


    <script>
        // --- CONFIGURAZIONE GITHUB (Sostituisce YouTube) ---
        const GITHUB_RAW_BASE = "https://raw.githubusercontent.com/ryzn-eu/AuraEU/main/";
        // ⭐ PATH AUDIO AGGIORNATO: ASSUME I FILE SONO IN /docs/audio/
        const AUDIO_BASE_URL = GITHUB_RAW_BASE + "docs/audio/"; 
        const FALLBACK_COVER_URL = "https://raw.githubusercontent.com/ryzn-eu/AuraEU/main/Covers/a8e71d4d-18b1-468b-9e3c-819fe551bb3a.jpg";
        
        // Percorsi JSON ora assoluti per il FETCH REMOTO
        const VIDEO_JSON_URL = GITHUB_RAW_BASE + "video.json"; 
        const TRACKS_JSON_URL = GITHUB_RAW_BASE + "tracks.json"; 
        
        // --- Dati & Configurazione Locali ---
        let AURA_MAP = []; 
        
        let currentTrackData = null;
        let audioPlayer = null; 
        let immersiveVideoPlayer = null; 
        let isImmersiveVideoActive = false; 

        let likedTracks = new Set();
        let userPlaylists = [];
        let isLooping = false;
        let loggedInUser = null;
        let listeningHistory = []; 
        
        let activeFilter = 'Trending'; 
        
        // Riferimenti DOM
        let progressBar, progressBarImmersive, playIcon, immersivePlayIcon, playerTitle, playerArtist, playerCover, immersiveCover, immersiveTitle, immersiveArtist, likeButton, vibeScoreDisplay, progressBarContainer, progressBarImmersiveContainer, loopButtonImmersive, playerBar, switchToVideoBtn, switchToVideoPipBtn;

        let trackIdToAdd = null; 
        
        // --- Stili e Icone per Mood Grid Migliorata (Natale/Glaciale) ---
        const MOOD_STYLES = {
            "Invernale": "bg-blue-900/40 border-blue-600 text-blue-300",
            "Party": "bg-red-900/40 border-red-600 text-red-300",
            "Ambient": "bg-gray-800/40 border-gray-600 text-gray-300",
            "Chill": "bg-cyan-900/40 border-cyan-600 text-cyan-300"
        };
        const ALL_MOODS = Object.keys(MOOD_STYLES);
        // -------------------------------------------------------------
        
        // ====================================================================
        // FUNZIONI HTML5 PLAYER API (Sostituiscono YouTube)
        // ====================================================================

        function onTrackEnded() {
            if (isLooping) {
                audioPlayer.currentTime = 0;
                audioPlayer.play();
            } else {
                skipForward();
            }
        }
        
        function onPlayerPlay() {
            togglePlayIcon(false); // false = mostra PAUSE
            updateMediaSession();
            playerBar.classList.add('active');
        }
        
        function onPlayerPause() {
            togglePlayIcon(true); // true = mostra PLAY
            updateMediaSession();
        }

        // ====================================================================
        // FUNZIONI DI GESTIONE DATI E API (DINAMICHE)
        // ====================================================================

        function getCoverUrl(title) {
            return FALLBACK_COVER_URL;
        }

        /**
         * Carica i brani dai JSON remoti usando fetch.
         */
        async function fetchTracks() {
            const container = document.getElementById('home-widgets-container');
            if (container) {
                container.innerHTML = `<p class="text-center text-gray-400 col-span-full"><i data-lucide="loader-2" class="w-5 h-5 animate-spin inline-block mr-2"></i> Caricamento brani da GitHub... </p>`;
                lucide.createIcons();
            }

            try {
                // Tenta di recuperare i file JSON dal percorso GitHub specificato
                const tracksResponse = await fetch(TRACKS_JSON_URL);
                const videosResponse = await fetch(VIDEO_JSON_URL);

                if (!tracksResponse.ok || !videosResponse.ok) {
                     // Questo errore si verifica se i file non sono trovati (404) o se CORS è bloccato (0)
                     throw new Error(`Impossibile recuperare uno o entrambi i file JSON. Controlla che siano su GitHub ai path corretti (${TRACKS_JSON_URL} e ${VIDEO_JSON_URL}).`);
                }

                const tracksData = await tracksResponse.json();
                const videosData = await videosResponse.json();
                
                const videoMap = new Map();
                videosData.forEach(video => {
                    videoMap.set(video.title, video.videoUrl);
                });

                // Costruisci AURA_MAP
                const tracks = tracksData.tracks || [];
                const results = tracks.map((track) => {
                    const title = track.title;
                    
                    // ⭐ NORMALIZZAZIONE E SANIFICAZIONE URL PIÙ ROBUSTA
                    let normalizedFile = track.file.trim(); 
                    normalizedFile = normalizedFile.replace(/\s(\.[a-zA-Z0-9]+)$/, '$1'); 
                    const encodedFile = encodeURIComponent(normalizedFile);
                    const audioUrl = AUDIO_BASE_URL + encodedFile; 
                    
                    const videoUrl = videoMap.get(title) || null; 
                    const cover = getCoverUrl(title); 
                    
                    return {
                        id: title, 
                        title: title,
                        artist: "Aura Choise", 
                        cover: cover,
                        audioUrl: audioUrl, 
                        videoUrl: videoUrl, 
                        mood: getTrackMood(), 
                        vibe: Math.floor(Math.random() * 100) + 1,
                        color: getRandomAccentColor(), 
                        rgb: getRandomAccentRGB()
                    };
                });
                
                AURA_MAP = results;
                
                renderHomePageWidgets(); 

            } catch (error) {
                console.error("Errore nel recupero dei brani locali:", error);
                container.innerHTML = `<p class="text-center p-4 text-red-400 col-span-full">
                    <i data-lucide="alert-triangle" class="w-5 h-5 inline-block mr-2"></i> 
                    Errore nel caricamento dei dati: ${error.message}. <br> 
                    Se stai usando il file in locale, è probabile che il browser abbia bloccato l'accesso ai file remoti (CORS).
                </p>`;
                AURA_MAP = [];
                lucide.createIcons();
            }
        }
        
        function getRandomAccentColor() {
            const colors = ['#00BFFF', '#34D399', '#FCD34D', '#FF007F', '#8B5CF6']; // Glacial, Mint, Gold, Magenta, Violet
            return colors[Math.floor(Math.random() * colors.length)];
        }
        function getRandomAccentRGB() {
            const rgbs = ['0 191 255', '52 211 153', '252 211 77', '255 0 127', '139 92 246'];
            return rgbs[Math.floor(Math.random() * rgbs.length)];
        }
        function getTrackMood() {
            // Assegna un mood casuale per i trending
            const moods = ALL_MOODS;
            return moods[Math.floor(Math.random() * moods.length)];
        }
        
        // ⭐ FIX: Cambiato "snowflakes" con "snowflake" (Lucide icon) e "Chill"
        function getMoodIcon(mood) {
            switch (mood) {
                case "Invernale": return "snowflake"; 
                case "Party": return "sparkles";
                case "Ambient": return "cloud-drizzle";
                case "Chill": return "cloud-snow"; // Per variazione con Invernale
                default: return "music";
            }
        }
        
        // Aggiorna la cronologia di ascolto
        function updateListeningHistory(trackId) {
            listeningHistory = listeningHistory.filter(id => id !== trackId);
            listeningHistory.unshift(trackId);
            listeningHistory = listeningHistory.slice(0, 50);
            localStorage.setItem('aura_listening_history', JSON.stringify(listeningHistory));
        }


        // --- Funzioni di Autenticazione (Invariante) ---
        function openAuthModal(mode) {
             document.getElementById('auth-modal').classList.remove('hidden');
             switchAuthMode(mode);
        }
        function closeAuthModal() {
             document.getElementById('auth-modal').classList.add('hidden');
        }
        function switchAuthMode(mode) {
            const title = document.getElementById('auth-title');
            const button = document.getElementById('auth-main-button');
            const link = document.getElementById('auth-switch-link');
            
            if (mode === 'login') {
                title.textContent = 'Accedi ad Aura Music';
                button.textContent = 'Accedi';
                button.onclick = () => handleAuthAction('login');
                link.textContent = 'Registrati';
                link.onclick = () => switchAuthMode('register');
            } else {
                title.textContent = 'Registrati ad Aura Music';
                button.textContent = 'Registrati';
                button.onclick = () => handleAuthAction('register');
                link.textContent = 'Accedi';
                link.onclick = () => switchAuthMode('login');
            }
        }
        function handleAuthAction(mode) {
            const email = document.getElementById('auth-email').value;
            const password = document.getElementById('auth-password').value;
            
            if (!email || !password) {
                showToast("Inserisci email e password.", 'error');
                return;
            }
            
            if (mode === 'register') {
                 loggedInUser = { email: email, vibeScore: 0 };
                 showToast("Registrazione Eseguita!", 'success');
            } else {
                 loggedInUser = { email: email, vibeScore: 50 }; 
                 showToast("Accesso Eseguito!", 'success');
            }

            saveLocalData();
            updateAuthUI(loggedInUser);
            closeAuthModal();
            showSection('profile'); 
        }

        window.handleLogout = function() {
            loggedInUser = null;
            saveLocalData();
            updateAuthUI(null);
            showToast("Disconnessione Eseguita.", 'info');
            showSection('music'); 
        }

        /**
         * Funzioni di riproduzione del player HTML5
         */
        window.playTrack = function(trackId, autoplay = true) {
            const track = AURA_MAP.find(t => t.id === trackId);
            if (!track) return;

            currentTrackData = track;
            
            // AGGIORNA CRONOLOGIA ASCOLTO
            updateListeningHistory(trackId); 

            try {
                // Imposta la sorgente audio (Fix 2 assicura l'URL corretto)
                audioPlayer.src = track.audioUrl;
                
                // Prepara il player immersivo
                immersiveVideoPlayer.src = track.videoUrl || '';
                
                // Assicurati che l'immersivo inizi con la cover (audio mode)
                // Questo disabilita l'audioPlayer.muted se il video non è attivo
                setImmersiveVisual('cover'); 
                
                if (autoplay) {
                    const attemptPlay = audioPlayer.play();
                    if (attemptPlay && typeof attemptPlay.catch === 'function') {
                         attemptPlay.catch(e => {
                            showToast("Riproduzione bloccata dal browser. Premi PLAY per iniziare.", 'error');
                            togglePlayIcon(true);
                         });
                    }
                }
                

            } catch (e) {
                showToast("Errore nel caricamento del brano.", 'error');
                console.error("Errore playTrack:", e);
            }

            updateUI(track);
            playerBar.classList.add('active'); 
        }

        window.togglePlayPause = function() {
            if (!audioPlayer) return;
            
            if (!currentTrackData) {
                if (AURA_MAP.length > 0) {
                    playTrack(AURA_MAP[0].id);
                } else {
                    showToast("Nessun brano da riprodurre. Verifica il caricamento dati.", 'info');
                }
                return;
            }

            if (audioPlayer.paused) {
                const attemptPlay = audioPlayer.play();
                 if (attemptPlay && typeof attemptPlay.catch === 'function') {
                     attemptPlay.catch(e => {
                        showToast("Riproduzione manuale richiesta.", 'info');
                     });
                 }
                 // Riproduci il video solo se è attivo (isImmersiveVideoActive)
                 if(isImmersiveVideoActive) immersiveVideoPlayer.play();
            } else {
                audioPlayer.pause();
                // Metti in pausa il video solo se è attivo (isImmersiveVideoActive)
                if(isImmersiveVideoActive) immersiveVideoPlayer.pause();
            }
        }
        
        function togglePlayIcon(isPaused) {
            const iconName = isPaused ? 'play' : 'pause';
            if (playIcon) {
                playIcon.setAttribute('data-lucide', iconName);
            }
            if (immersivePlayIcon) {
                immersivePlayIcon.setAttribute('data-lucide', iconName);
            }
            lucide.createIcons(); 
        }


        window.skipForward = function() {
            if (!currentTrackData) return;
            const currentIndex = AURA_MAP.findIndex(t => t.id === currentTrackData.id);
            const nextIndex = (currentIndex + 1) % AURA_MAP.length;
            playTrack(AURA_MAP[nextIndex].id);
        }

        window.skipBackward = function() {
            if (!currentTrackData) return;
            const currentIndex = AURA_MAP.findIndex(t => t.id === currentTrackData.id);
            const prevIndex = (currentIndex - 1 + AURA_MAP.length) % AURA_MAP.length;
            playTrack(AURA_MAP[prevIndex].id);
        }

        window.toggleLoop = function() {
            isLooping = !isLooping;
            updateLoopButton(isLooping);
            saveLocalData();
            showToast(isLooping ? 'Ripetizione Attivata' : 'Ripetizione Disattivata', 'info');
        }

        function updateLoopButton(isLooping) {
            const loopIcon = document.getElementById('loop-button-immersive').querySelector('i');
            if (loopIcon) {
                if (isLooping) {
                    loopIcon.setAttribute('data-lucide', 'repeat-one');
                    loopIcon.classList.add('accent-text');
                    loopIcon.classList.remove('text-white/70');
                } else {
                    loopIcon.setAttribute('data-lucide', 'repeat');
                    loopIcon.classList.remove('accent-text');
                    loopIcon.classList.add('text-white/70');
                }
            }
            lucide.createIcons();
        }

        function updateProgress() {
            if (!audioPlayer || !progressBar || !progressBarImmersive) return;
            
            const duration = audioPlayer.duration;
            const currentTime = audioPlayer.currentTime;

            if (duration > 0) {
                const percentage = (currentTime / duration) * 100;
                progressBar.style.width = `${percentage}%`;
                progressBarImmersive.style.width = `${percentage}%`;
            }
        }
        
        // --- Funzioni Switch A/V Immersivo ---
        
        /**
         * Imposta la visualizzazione Immersiva: 'video' o 'cover' (audio).
         */
        function setImmersiveVisual(mode) {
             if(!currentTrackData) return;
             
             const icon = switchToVideoBtn ? switchToVideoBtn.querySelector('i') : null; // Riferimento sicuro
             
             // Il video è disponibile?
             const videoAvailable = currentTrackData.videoUrl && immersiveVideoPlayer && immersiveVideoPlayer.src;

             if (mode === 'video' && videoAvailable) {
                // Modalità Video (Audio Muto sul Player Principale)
                isImmersiveVideoActive = true;
                immersiveCover.classList.add('hidden');
                immersiveVideoPlayer.classList.remove('hidden');
                
                // Sincronizza e avvia il video, muta l'audio principale
                immersiveVideoPlayer.currentTime = audioPlayer.currentTime;
                // Rimuovi il muto dal player video (ha già l'attributo muted nell'HTML, ma in caso)
                immersiveVideoPlayer.muted = false; 
                // Il video player deve avere il volume attivo, ma in un setup corretto l'audio principale
                // deve essere disattivato per non avere doppio audio.
                audioPlayer.muted = true; 

                if (!audioPlayer.paused) {
                    immersiveVideoPlayer.play();
                } else {
                    immersiveVideoPlayer.pause();
                }
                
                // ⭐ FIX: Aggiunto controllo null
                if (icon) {
                    icon.setAttribute('data-lucide', 'monitor-smartphone'); // Icona per tornare all'audio
                }
             } else {
                // Modalità 'cover' (audio)
                isImmersiveVideoActive = false;
                immersiveCover.classList.remove('hidden');
                immersiveVideoPlayer.classList.add('hidden');

                // Pausa il video (se attivo), riattiva l'audio principale
                immersiveVideoPlayer.pause();
                // Disattiva il muto sul player audio
                audioPlayer.muted = false; 
                
                // ⭐ FIX: Aggiunto controllo null
                if (icon) {
                    icon.setAttribute('data-lucide', 'video'); // Icona per passare al video
                }
             }
             // Mostra/nascondi il tasto switch A/V nella modal
             if (switchToVideoBtn) switchToVideoBtn.classList.toggle('hidden', !videoAvailable);
             if (switchToVideoPipBtn) switchToVideoPipBtn.classList.toggle('hidden', !videoAvailable);
             lucide.createIcons();
        }
        
        /**
         * Funzione per il pulsante all'interno della modal: switch tra Cover e Video.
         */
        window.toggleImmersiveVisuals = function() {
            const newMode = !isImmersiveVideoActive ? 'video' : 'cover';
            setImmersiveVisual(newMode);
        }

        /**
         * Entra in modalità immersiva. Può prendere un parametro per preferire il video.
         */
        window.enterImmersiveMode = function(preferredMode = 'audio') {
            if (!currentTrackData) {
                showToast("Seleziona un brano prima.", 'info');
                return;
            }
            document.getElementById('immersive-mode').classList.remove('hidden');
            document.body.style.overflow = 'hidden';
            updateProgress(); 
            
            // Imposta la visuale preferita
            const finalMode = (preferredMode === 'video' && currentTrackData.videoUrl) ? 'video' : 'cover';
            setImmersiveVisual(finalMode);
        }

        window.exitImmersiveMode = function() {
            document.getElementById('immersive-mode').classList.add('hidden');
            document.body.style.overflow = 'auto';
            // Se esco, torno sempre all'audio (per riattivare l'audioPlayer)
            setImmersiveVisual('cover'); 
        }

        function handleSeek(event) {
            if (!audioPlayer || !currentTrackData) return;
            const duration = audioPlayer.duration;
            if (duration <= 0) return;

            const container = event.currentTarget;
            const clickX = event.clientX - container.getBoundingClientRect().left;
            const width = container.offsetWidth;
            const seekTime = (clickX / width) * duration;
            audioPlayer.currentTime = seekTime;
            // Sincronizza anche il video se attivo
            if(isImmersiveVideoActive) immersiveVideoPlayer.currentTime = seekTime;
        }

        function setupSeekListeners() {
            if(progressBarContainer) progressBarContainer.addEventListener('click', handleSeek);
            if(progressBarImmersiveContainer) progressBarImmersiveContainer.addEventListener('click', handleSeek);
        }
        
        function updateUI(track) {
            playerTitle.textContent = track.title;
            playerArtist.textContent = track.artist;
            playerCover.src = track.cover;

            immersiveTitle.textContent = track.title;
            immersiveArtist.textContent = track.artist;
            immersiveCover.src = track.cover;
            
            vibeScoreDisplay.textContent = `Vibe Score: ${track.vibe}/100`;

            updateAmbientLight(track.color || '#00BFFF', track.rgb || '0 191 255');
            updateLikeButton(track.id);
            
            const hasVideo = !!track.videoUrl;
            if (switchToVideoPipBtn) switchToVideoPipBtn.classList.toggle('hidden', !hasVideo);
            if (switchToVideoBtn) switchToVideoBtn.classList.toggle('hidden', !hasVideo);
            
            togglePlayIcon(audioPlayer.paused); 
            lucide.createIcons(); 
        }

        function updateAmbientLight(hexColor, rgbColor) {
            if (hexColor) {
                document.documentElement.style.setProperty('--ryzn-color-hex', hexColor);
            }
            if (rgbColor) {
                document.documentElement.style.setProperty('--ryzn-color-rgb', rgbColor);
            }
        }

        // --- Logica Like/Playlist/UI (Invariante) ---
        function saveLocalData() {
            localStorage.setItem('aura_liked_tracks', JSON.stringify(Array.from(likedTracks)));
            localStorage.setItem('aura_playlists', JSON.stringify(userPlaylists));
            localStorage.setItem('aura_user', JSON.stringify(loggedInUser));
            localStorage.setItem('aura_loop_status', JSON.stringify(isLooping));
        }

        function loadLocalData() {
            try {
                const savedLikes = localStorage.getItem('aura_liked_tracks');
                if (savedLikes) {
                    likedTracks = new Set(JSON.parse(savedLikes));
                }
                const savedPlaylists = localStorage.getItem('aura_playlists');
                if (savedPlaylists) {
                    userPlaylists = JSON.parse(savedPlaylists);
                }
                const savedUser = localStorage.getItem('aura_user');
                if (savedUser && savedUser !== 'null') {
                    loggedInUser = JSON.parse(savedUser);
                    updateAuthUI(loggedInUser);
                } else {
                    loggedInUser = null;
                }
                const savedLoop = localStorage.getItem('aura_loop_status');
                if (savedLoop) {
                    isLooping = JSON.parse(savedLoop);
                }
                const savedHistory = localStorage.getItem('aura_listening_history');
                if (savedHistory) {
                    listeningHistory = JSON.parse(savedHistory);
                }
                
            } catch(e) {
                console.error("Errore nel caricamento dei dati locali:", e);
            }
        }

        // --- Gestione Sezioni e Rendering Widgets (Invariante) ---
        window.showSection = function(sectionId, filter = activeFilter) {
            activeFilter = filter; 

            document.querySelectorAll('.section-page').forEach(section => {
                section.classList.remove('active');
            });
            const targetSection = document.getElementById(`${sectionId}-section`);
            if (targetSection) {
                targetSection.classList.add('active');
            }
            
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });
            const activeItem = document.getElementById(`nav-${sectionId}`);
            if (activeItem) {
                activeItem.classList.add('active');
            }
            
            if (sectionId === 'music') {
                renderHomePageWidgets(); 
            } else if (sectionId === 'library') {
                renderLikedTracks();
            } else if (sectionId === 'playlists') {
                renderPlaylists();
            }
        }
        
        window.toggleLike = function(optionalTrackId) {
            const trackId = optionalTrackId || currentTrackData?.id;
            if (!trackId) {
                showToast("Seleziona una traccia prima.", 'error');
                return;
            }
            const track = AURA_MAP.find(t => t.id === trackId);
            if (!track) return;
            
            if (likedTracks.has(trackId)) {
                likedTracks.delete(trackId);
                showToast(`Rimosso: ${track.title}`, 'info');
            } else {
                likedTracks.add(trackId);
                showToast(`Aggiunto ai Preferiti: ${track.title}`, 'success');
            }
            
            saveLocalData();
            updateLikeButton(trackId);
            renderLikedTracks(); 
        }

        function updateLikeButton(trackId) {
            const isLiked = likedTracks.has(trackId);
            const button = document.getElementById('like-button');
            if (button) {
                button.classList.toggle('text-red-400', isLiked);
                button.classList.toggle('text-white/50', !isLiked);
            }
            const buttonImmersive = document.getElementById('like-button-immersive');
            if (buttonImmersive) {
                buttonImmersive.classList.toggle('text-red-400', isLiked);
                buttonImmersive.classList.toggle('text-white/70', !isLiked);
            }
        }

        /**
         * Elemento per la griglia 3x2 dell'Accesso Rapido
         */
        function getQuickAccessTrackCard(track) {
            // Semplificata per il layout Grid 3x2
            return `
                 <div onclick="playTrack('${track.id}')" class="depth-glass p-2 rounded-lg cursor-pointer transition hover:scale-[1.02] border border-transparent hover:accent-border flex items-center space-x-3">
                     <img src="${track.cover}" alt="${track.title}" class="w-12 h-12 rounded-lg object-cover flex-shrink-0">
                     <p class="text-white font-bold truncate text-sm">${track.title}</p>
                 </div>
            `;
        }

        function getTrackElement(track) {
            return `
                <div onclick="playTrack('${track.id}')" class="widget-row-item cursor-pointer transition hover:opacity-80">
                    <img src="${track.cover}" alt="${track.title}" class="w-full aspect-square rounded-lg object-cover shadow-lg shadow-ryzn-accent/10 mb-2">
                    <p class="text-white font-bold text-sm truncate">${track.title}</p>
                    <p class="text-gray-400 text-xs truncate">${track.artist}</p>
                </div>
            `;
        }
        
        function createWidgetBlock(title, subtitle, contentHtml, layout = 'horizontal-scroll') {
            let contentClasses = 'widget-row';
            if (layout === 'grid') {
                contentClasses = 'grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-4';
            } else if (layout === 'quick-access') {
                 contentClasses = ''; 
            }
            
            return `
                 <div>
                     <h3 class="text-2xl font-bold mb-2">${title}</h3>
                     ${subtitle ? `<p class="text-gray-400 mb-4">${subtitle}</p>` : ''}
                     <div class="${contentClasses}">
                         ${contentHtml}
                     </div>
                 </div>
            `;
        }
        
        function getMoodGridHtml() {
            return ALL_MOODS.map(mood => {
                const styleClass = MOOD_STYLES[mood] || 'bg-gray-700/40 border-gray-500 text-gray-300';
                const icon = getMoodIcon(mood);
                
                return `
                    <div onclick="showMoodTracks('${mood}')" class="depth-glass ${styleClass} p-4 rounded-xl cursor-pointer transition hover:scale-[1.03] border-2 shadow-lg flex flex-col items-center justify-center text-center space-y-2 min-h-[120px]">
                        <i data-lucide="${icon}" class="w-8 h-8 ${MOOD_STYLES[mood].includes('text-') ? '' : 'text-white'}"></i>
                        <p class="font-bold text-lg">${mood}</p>
                    </div>
                `;
            }).join('');
        }

        window.renderHomePageWidgets = function() {
            const container = document.getElementById('home-widgets-container');
            if (!container) return;

            const currentHour = new Date().getHours();
            let greeting = "Buonasera.";
            if (currentHour < 12) greeting = "Buongiorno.";
            else if (currentHour < 18) greeting = "Buon Pomeriggio.";
            document.getElementById('home-greeting').textContent = `${greeting} La tua Vibe è pronta.`;

            if (AURA_MAP.length === 0) {
                // Se i dati non sono caricati, non sovrascrivere l'errore se è già presente
                if (container.innerHTML.indexOf('Errore nel caricamento') === -1) {
                     container.innerHTML = '<p class="text-center text-gray-500 col-span-full">Nessun brano caricato. Riprova più tardi.</p>';
                }
                return;
            }

            let allWidgetsHtml = '';

            // --- LOGICA DI FILTRO (Mood) ---
            if (activeFilter !== 'Trending') {
                const filteredTracks = AURA_MAP.filter(t => t.mood === activeFilter);
                const filteredHtml = filteredTracks.map(getTrackElement).join('');
                
                const backButtonHtml = `
                    <button onclick="showSection('music', 'Trending')" class="flex items-center text-gray-400 hover:accent-text transition mb-6">
                        <i data-lucide="arrow-left" class="w-6 h-6 mr-2"></i>
                        Torna alla Home
                    </button>
                `;
                
                container.innerHTML = backButtonHtml + createWidgetBlock(`Risultati: ${activeFilter}`, 'Brani selezionati in base al tuo mood.', filteredHtml, 'grid');
                lucide.createIcons();
                return;
            }
            
            const shuffled = [...AURA_MAP].sort(() => 0.5 - Math.random());

            // ⭐ WIDGET 1: Accesso Rapido (3x2 ordinato per cronologia)
            const historyTracks = listeningHistory
                .map(id => AURA_MAP.find(t => t.id === id))
                .filter(t => t); 
                
            const quickAccessTracks = historyTracks.slice(0, 6);
            
            const quickAccessHtml = quickAccessTracks.map(getQuickAccessTrackCard).join('');
            
            // Layout Grid 3x2
            const quickAccessWidgetHtml = `
                 <div>
                     <h3 class="text-2xl font-bold mb-4">Accesso Rapido (Cronologia)</h3>
                     <div class="grid grid-cols-2 lg:grid-cols-3 gap-4">
                         ${quickAccessHtml || '<p class="col-span-full text-gray-500">Inizia ad ascoltare per vedere la cronologia qui.</p>'}
                     </div>
                 </div>
            `;
            allWidgetsHtml += quickAccessWidgetHtml;
            
            // ⭐ WIDGET 2: Scegli la Vibe (SPOSTATO QUI)
            const moodGridHtml = getMoodGridHtml();
            allWidgetsHtml += createWidgetBlock('Scegli la Vibe', 'Seleziona il tuo mood attuale.', moodGridHtml, 'grid grid-cols-2 sm:grid-cols-4 gap-4');

            // --- DISCLAIMER ---
            const disclaimerHtml = `
                <div class="my-10 p-6 rounded-2xl depth-glass border-l-4 border-red-500 shadow-xl">
                    <h3 class="text-xl font-bold text-red-400 flex items-center mb-2">
                        <i data-lucide="alert-triangle" class="w-6 h-6 mr-3 flex-shrink-0"></i>
                        ⚠️ Avviso Beta - Ryzn Developer ⚠️
                    </h3>
                    <p class="text-white/90">
                        Questo programma è in **fase Beta**. Potrebbero essere riscontrati bug o malfunzionamenti. 
                        La tua collaborazione è fondamentale per la Vibe perfetta.
                    </p>
                    <p class="text-sm mt-3 text-red-300">
                        Se trovi i problemi, segnalali per favore su 
                        <a href="https://Ryznmusic.it" target="_blank" class="font-bold underline hover:text-white transition">Ryznmusic.it</a>.
                    </p>
                </div>
            `;
            allWidgetsHtml += disclaimerHtml;

            // ⭐ WIDGET 3: Playlist Natalizia 1 
            // Usa una selezione di tracce casuali, assicurandosi di non superare la lunghezza di AURA_MAP
            const sliceEnd1 = Math.min(6 + 10, AURA_MAP.length);
            const playlist1Tracks = shuffled.slice(6, sliceEnd1);
            const playlist1Html = playlist1Tracks.map(getTrackElement).join('');
            allWidgetsHtml += createWidgetBlock('Playlist Natalizia: Atmosfera Glaciale', 'Un mix di suoni chill e ambientali per l\'inverno.', playlist1Html, 'grid');

            // ⭐ WIDGET 4: Playlist Natalizia 2
            const sliceEnd2 = Math.min(sliceEnd1 + 10, AURA_MAP.length);
            const playlist2Tracks = shuffled.slice(sliceEnd1, sliceEnd2);
            const playlist2Html = playlist2Tracks.map(getTrackElement).join('');
            allWidgetsHtml += createWidgetBlock('Playlist Natalizia: Le Hit delle Feste', 'Le canzoni che non possono mancare durante le vacanze.', playlist2Html, 'grid');
            
            container.innerHTML = allWidgetsHtml;
            lucide.createIcons();
        }
        
        window.showMoodTracks = function(mood) {
            activeFilter = mood;
            renderHomePageWidgets(); 
        }

        // --- Altre Funzioni (Invariante) ---
        function getLikedTrackElement(track) {
            return `
                 <div onclick="playTrack('${track.id}')" class="depth-glass p-3 rounded-xl flex items-center space-x-4 cursor-pointer hover:bg-white/10 transition">
                     <img src="${track.cover}" alt="${track.title}" class="w-12 h-12 rounded-md object-cover flex-shrink-0">
                     <div class="flex-grow truncate">
                         <p class="text-white font-bold truncate">${track.title}</p>
                         <p class="text-gray-400 text-sm truncate">${track.artist}</p>
                     </div>
                     <button onclick="event.stopPropagation(); toggleLike('${track.id}')" class="p-2 text-red-400 hover:text-red-500 transition flex-shrink-0">
                         <i data-lucide="heart" class="w-5 h-5 fill-current"></i>
                     </button>
                 </div>
            `;
        }

        function renderLikedTracks() {
            const container = document.getElementById('liked-tracks-list');
            const likedTracksArray = Array.from(likedTracks);
            const tracksHtml = likedTracksArray
                .map(id => AURA_MAP.find(t => t.id === id))
                .filter(t => t)
                .map(track => getLikedTrackElement(track))
                .join('');
                
            if (tracksHtml.length === 0) {
                container.innerHTML = '<p class="text-center p-4 text-gray-500">Nessun brano salvato.</p>';
            } else {
                container.innerHTML = tracksHtml;
            }
            lucide.createIcons();
        }

        function updateAuthUI(user) {
            const authButton = document.getElementById('auth-button-header');
            const profileInfo = document.getElementById('profile-info');

            if (authButton) {
                const icon = authButton.querySelector('i');
                if (user) {
                    icon.setAttribute('data-lucide', 'user-check');
                    authButton.classList.add('accent-border');
                    authButton.classList.add('border-2');
                    authButton.onclick = () => showSection('profile');
                } else {
                    icon.setAttribute('data-lucide', 'user');
                    authButton.classList.remove('accent-border');
                    authButton.classList.remove('border-2');
                    authButton.onclick = () => openAuthModal('login');
                }
            }
            
            if (profileInfo) {
                profileInfo.textContent = user ? `Utente: ${user.email}` : 'Stato: Disconnesso';
            }
        }

        function showToast(message, type = 'info') {
            const container = document.getElementById('toast-container');
            if (!container) return;

            const toast = document.createElement('div');
            let bgColor = 'bg-gray-700';
            let icon = 'info';

            if (type === 'success') {
                bgColor = 'bg-green-600';
                icon = 'check-circle';
            } else if (type === 'error') {
                bgColor = 'bg-red-600';
                icon = 'x-circle';
            } else if (type === 'info') {
                bgColor = 'bg-blue-600';
                icon = 'bell';
            }

            toast.className = `p-4 mb-3 rounded-lg text-white shadow-xl ${bgColor} flex items-center transition-all duration-300 transform translate-x-0 opacity-100`;
            toast.innerHTML = `<i data-lucide="${icon}" class="w-5 h-5 mr-3 flex-shrink-0"></i> <span>${message}</span>`;
            
            container.appendChild(toast);
            lucide.createIcons();

            setTimeout(() => {
                toast.classList.remove('opacity-100');
                toast.classList.add('opacity-0', 'translate-x-full');
                toast.addEventListener('transitionend', () => toast.remove());
            }, 3000);
        }

        function openSearchModal() {
            document.getElementById('search-modal').classList.remove('hidden');
            document.getElementById('search-input').focus();
        }

        function closeSearchModal() {
            document.getElementById('search-modal').classList.add('hidden');
            document.getElementById('search-results').innerHTML = '<p class="text-center text-gray-500">Inizia a digitare per cercare musica.</p>';
        }

        function performSearch() {
             const query = document.getElementById('search-input').value.trim().toLowerCase();
             const resultsContainer = document.getElementById('search-results');

             if (query.length < 2) {
                 resultsContainer.innerHTML = '<p class="text-center text-gray-500">Digita almeno 2 caratteri...</p>';
                 return;
             }
             
             resultsContainer.innerHTML = '<p class="text-center text-gray-400"><i data-lucide="loader-2" class="w-5 h-5 animate-spin inline-block mr-2"></i> Ricerca in corso...</p>';
             lucide.createIcons();
             
             const results = AURA_MAP.filter(track => 
                track.title.toLowerCase().includes(query) ||
                track.artist.toLowerCase().includes(query)
             );

             if (results.length === 0) {
                 resultsContainer.innerHTML = '<p class="text-center text-gray-500">Nessun risultato trovato per la tua ricerca.</p>';
             } else {
                 resultsContainer.innerHTML = `<div class="space-y-3">${results.map(track => getLikedTrackElement(track)).join('')}</div>`;
             }
             lucide.createIcons();
        }
        
        function openCreatePlaylistModal() {
            document.getElementById('create-playlist-modal').classList.remove('hidden');
            document.getElementById('playlist-name-input').focus();
        }

        function closeCreatePlaylistModal() {
            document.getElementById('create-playlist-modal').classList.add('hidden');
        }

        function createPlaylist() {
            const name = document.getElementById('playlist-name-input').value.trim();
            if (name.length < 3) {
                showToast("Il nome della Sessione deve avere almeno 3 caratteri.", 'error');
                return;
            }
            
            const newPlaylist = {
                id: Date.now().toString(),
                name: name,
                tracks: []
            };
            userPlaylists.push(newPlaylist);
            saveLocalData();
            showToast(`Sessione "${name}" creata!`, 'success');
            closeCreatePlaylistModal();
            renderPlaylists();
        }

        function renderPlaylists() {
            const container = document.getElementById('playlists-list');
            if (userPlaylists.length === 0) {
                container.innerHTML = '<p class="text-center p-4 text-gray-500 col-span-full">Nessuna sessione creata.</p>';
                return;
            }

            container.innerHTML = userPlaylists.map(playlist => {
                const trackCount = playlist.tracks.length;
                const covers = playlist.tracks.slice(0, 4)
                               .map(id => AURA_MAP.find(t => t.id === id)?.cover || FALLBACK_COVER_URL)
                               .filter(Boolean); 

                return `
                    <div class="depth-glass p-4 rounded-xl space-y-3 flex flex-col justify-between cursor-pointer transition hover:bg-white/10 relative">
                        <div>
                             <h3 class="text-xl font-bold accent-text truncate">${playlist.name}</h3>
                             <p class="text-sm text-gray-400 mb-3">${trackCount} brani</p>
                        </div>
                        
                        <div onclick="event.stopPropagation(); playPlaylist('${playlist.id}')" class="flex items-center justify-between">
                            <div class="grid grid-cols-2 gap-1 w-24 aspect-square rounded-lg overflow-hidden flex-shrink-0 bg-black/20">
                                ${covers.map(cover => `<img src="${cover}" alt="Cover" class="w-full h-full object-cover">`).join('')}
                                ${Array(4 - covers.length).fill('<div class="w-full h-full bg-white/5"></div>').join('')}
                            </div>
                            
                            <button onclick="event.stopPropagation(); playPlaylist('${playlist.id}')" class="p-3 accent-bg rounded-full hover:scale-110 transition shadow-lg shadow-ryzn-accent/50 ml-4">
                                <i data-lucide="play" class="w-6 h-6 text-ryzn-bg fill-ryzn-bg"></i>
                            </button>
                        </div>
                        
                        <button onclick="event.stopPropagation(); deletePlaylist('${playlist.id}')" class="absolute top-3 right-3 text-gray-500 hover:text-red-500 transition">
                            <i data-lucide="trash-2" class="w-5 h-5"></i>
                        </button>
                    </div>
                `;
            }).join('');
            lucide.createIcons();
        }

        window.openAddToPlaylistModal = function(optionalTrackId) {
             trackIdToAdd = optionalTrackId || currentTrackData?.id;
             if (!trackIdToAdd) {
                showToast("Seleziona una traccia da aggiungere.", 'error');
                return;
             }
             
             const listContainer = document.getElementById('playlist-selection-list');
             if (userPlaylists.length === 0) {
                 listContainer.innerHTML = `<p class="text-center text-gray-500">Nessuna sessione trovata. <button onclick="closeAddToPlaylistModal(); openCreatePlaylistModal()" class="accent-text">Creane una!</button></p>`;
             } else {
                 listContainer.innerHTML = userPlaylists.map(playlist => {
                      const isTrackInPlaylist = playlist.tracks.includes(trackIdToAdd);
                      return `
                         <div onclick="addToPlaylist('${playlist.id}', '${trackIdToAdd}', this)" class="depth-glass p-3 rounded-lg flex items-center justify-between cursor-pointer hover:bg-white/10 transition">
                             <p class="font-bold truncate">${playlist.name}</p>
                             <i data-lucide="${isTrackInPlaylist ? 'check' : 'plus'}" class="w-5 h-5 ${isTrackInPlaylist ? 'accent-text' : 'text-gray-400'}"></i>
                         </div>
                      `;
                 }).join('');
             }
             document.getElementById('add-to-playlist-modal').classList.remove('hidden');
             lucide.createIcons();
        }

        window.closeAddToPlaylistModal = function() {
            document.getElementById('add-to-playlist-modal').classList.add('hidden');
            trackIdToAdd = null;
        }

        window.addToPlaylist = function(playlistId, trackId, element) {
            const playlist = userPlaylists.find(p => p.id === playlistId);
            const track = AURA_MAP.find(t => t.id === trackId);
            if (!playlist || !track) return;
            
            const icon = element.querySelector('i');
            
            if (playlist.tracks.includes(trackId)) {
                playlist.tracks = playlist.tracks.filter(id => id !== trackId);
                showToast(`Rimosso da: ${playlist.name}`, 'info');
                icon.setAttribute('data-lucide', 'plus');
                icon.classList.remove('accent-text');
                icon.classList.add('text-gray-400');
            } else {
                playlist.tracks.push(trackId);
                showToast(`Aggiunto a: ${playlist.name}`, 'success');
                icon.setAttribute('data-lucide', 'check');
                icon.classList.add('accent-text');
                icon.classList.remove('text-gray-400');
            }
            saveLocalData();
            renderPlaylists(); 
            lucide.createIcons();
        }

        window.deletePlaylist = function(playlistId) {
            const index = userPlaylists.findIndex(p => p.id === playlistId);
            if (index > -1) {
                const name = userPlaylists[index].name;
                userPlaylists.splice(index, 1);
                saveLocalData();
                showToast(`Sessione "${name}" eliminata.`, 'info');
                renderPlaylists();
            }
        }

        window.playPlaylist = function(playlistId) {
            const playlist = userPlaylists.find(p => p.id === playlistId);
            if (!playlist || playlist.tracks.length === 0) {
                showToast("Sessione vuota. Aggiungi brani!", 'error');
                return;
            }

            const playableTracks = playlist.tracks
                .map(id => AURA_MAP.find(t => t.id === id))
                .filter(t => t);
            
            if (playableTracks.length === 0) {
                 showToast("Nessun brano valido trovato per questa sessione.", 'error');
                 return;
            }
            
            playTrack(playableTracks[0].id);
            showToast(`Riproduzione Sessione: ${playlist.name}`, 'info');
        }

        // ====================================================================
        // INIZIALIZZAZIONE E MEDIA SESSION (Adattati)
        // ====================================================================
        
        // Aggiunge fiocchi di neve casuali al container
        function createSnowflakes() {
            const snowContainer = document.getElementById('snow-container');
            const numFlakes = 50; 
            
            for (let i = 0; i < numFlakes; i++) {
                const flake = document.createElement('div');
                flake.className = 'flake';
                flake.innerHTML = '❅'; // Carattere fiocco di neve
                
                // Posizione iniziale casuale (orizzontale)
                const startX = Math.random() * 100;
                // Dimensione casuale
                const size = Math.random() * 10 + 8; // tra 8px e 18px
                // Durata caduta casuale
                const duration = Math.random() * 10 + 5; // tra 5s e 15s
                // Ritardo casuale
                const delay = Math.random() * 5; // tra 0s e 5s

                flake.style.left = `${startX}vw`;
                flake.style.fontSize = `${size}px`;
                flake.style.animationDuration = `${duration}s`;
                flake.style.animationDelay = `${delay}s`;
                
                snowContainer.appendChild(flake);
            }
        }


        function getDOMElements() {
            // Player HTML5
            audioPlayer = document.getElementById('audioPlayer');
            immersiveVideoPlayer = document.getElementById('immersive-video-player');
            switchToVideoBtn = document.getElementById('switch-to-video-btn'); // Modal switch
            switchToVideoPipBtn = document.getElementById('switch-to-video-pip'); // PIP switch

            // UI Player
            progressBar = document.getElementById('progress-bar');
            progressBarImmersive = document.getElementById('progress-bar-immersive');
            playIcon = document.getElementById('play-icon');
            immersivePlayIcon = document.getElementById('immersive-play-icon');
            playerTitle = document.getElementById('player-title');
            playerArtist = document.getElementById('player-artist');
            playerCover = document.getElementById('player-cover');
            immersiveTitle = document.getElementById('immersive-title');
            immersiveArtist = document.getElementById('immersive-artist');
            immersiveCover = document.getElementById('immersive-cover');
            likeButton = document.getElementById('like-button');
            vibeScoreDisplay = document.getElementById('vibe-score-display');
            progressBarContainer = document.getElementById('progress-bar-container');
            progressBarImmersiveContainer = document.getElementById('progress-bar-immersive-container');
            loopButtonImmersive = document.getElementById('loop-button-immersive');
            playerBar = document.querySelector('.player-bar');

            // Setup Eventi Player
            if(audioPlayer) {
                 audioPlayer.addEventListener('ended', onTrackEnded);
                 audioPlayer.addEventListener('play', onPlayerPlay);
                 audioPlayer.addEventListener('pause', onPlayerPause);
                 audioPlayer.addEventListener('timeupdate', updateProgress);
                 audioPlayer.addEventListener('seeked', () => {
                     // Sincronizza il video quando si cerca
                     if(isImmersiveVideoActive) immersiveVideoPlayer.currentTime = audioPlayer.currentTime;
                 });
            }


            setupSeekListeners(); 
            setupMediaSessionHandlers();
        }

        function setupMediaSessionHandlers() {
            if (!('mediaSession' in navigator)) return;

            navigator.mediaSession.metadata = new MediaMetadata({
                title: 'Aura Music',
                artist: 'Aura Choise',
                album: 'Vibe',
                artwork: [
                    { src: FALLBACK_COVER_URL, sizes: '192x192', type: 'image/jpeg' },
                ]
            });

            navigator.mediaSession.setActionHandler('play', () => togglePlayPause());
            navigator.mediaSession.setActionHandler('pause', () => togglePlayPause());
            navigator.mediaSession.setActionHandler('seekbackward', (details) => {
                 audioPlayer.currentTime = Math.max(0, audioPlayer.currentTime - (details.seekOffset || 10));
            });
            navigator.mediaSession.setActionHandler('seekforward', (details) => {
                 audioPlayer.currentTime = Math.min(audioPlayer.duration, audioPlayer.currentTime + (details.seekOffset || 10));
            });
            navigator.mediaSession.setActionHandler('previoustrack', () => skipBackward());
            navigator.mediaSession.setActionHandler('nexttrack', () => skipForward());
            
            navigator.mediaSession.setActionHandler('seekto', (details) => {
                if(details.seekTime !== undefined) audioPlayer.currentTime = details.seekTime;
            });
        }

        function updateMediaSession() {
            if (!('mediaSession' in navigator) || !currentTrackData || !audioPlayer) return;

            const isPlaying = !audioPlayer.paused;
            
            navigator.mediaSession.metadata = new MediaMetadata({
                 title: currentTrackData.title,
                 artist: currentTrackData.artist,
                 album: currentTrackData.mood,
                 artwork: [
                     { src: currentTrackData.cover, sizes: '192x192', type: 'image/jpeg' },
                 ]
            });

            if ('setPositionState' in navigator.mediaSession) {
                 navigator.mediaSession.setPositionState({
                     duration: audioPlayer.duration || 0,
                     playbackRate: audioPlayer.playbackRate,
                     position: audioPlayer.currentTime || 0
                 });
            }
            
            navigator.mediaSession.playbackState = isPlaying ? 'playing' : 'paused';
        }


        async function initializeAppContent() {
            
            // Rimozione del blocco PWA Manifest
            // const pwaLink = document.createElement('link');
            // pwaLink.rel = 'manifest';
            // pwaLink.href = '../manifest.json'; 
            // document.head.appendChild(pwaLink);

            loadLocalData();
            
            getDOMElements(); 
            createSnowflakes(); 
            
            await fetchTracks(); // ⭐ ABILITA IL FETCH DEI JSON REMOTI
            
            updateAmbientLight('#00BFFF', '0 191 255'); 
            
            updateLoopButton(isLooping); 
            
            showSection('music'); 
            
             if (playerBar) playerBar.classList.remove('active'); 
        }

        document.addEventListener('DOMContentLoaded', initializeAppContent);
    </script>
</body>
</html>